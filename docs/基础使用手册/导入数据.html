<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-基础使用手册/导入数据">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">导入数据 | ByConity</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://byconity.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://byconity.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://byconity.github.io/docs/基础使用手册/导入数据"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="导入数据 | ByConity"><meta data-rh="true" name="description" content="文档类型：教程型"><meta data-rh="true" property="og:description" content="文档类型：教程型"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://byconity.github.io/docs/基础使用手册/导入数据"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/基础使用手册/导入数据" hreflang="en"><link data-rh="true" rel="alternate" href="https://byconity.github.io/zh-cn/docs/基础使用手册/导入数据" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/基础使用手册/导入数据" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ByConity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ByConity Atom Feed"><link rel="stylesheet" href="/assets/css/styles.320eaf13.css">
<link rel="preload" href="/assets/js/runtime~main.42b9ce04.js" as="script">
<link rel="preload" href="/assets/js/main.081140d6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_dYNx" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--light_CjtC"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--dark_quyK"></div><b class="navbar__title text--truncate">ByConity</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/ByConity简介/主要原理概念">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_B_6h"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/基础使用手册/导入数据" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/基础使用手册/导入数据" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ldyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MxCR docsWrapper_h_X8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Kzpt" type="button"></button><div class="docPage_GWs5"><aside class="theme-doc-sidebar-container docSidebarContainer_ldoy"><div class="sidebarViewport_TwFD"><div class="sidebar_H_01"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_J18w"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/ByConity简介/主要原理概念">ByConity简介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/SQL语法说明/ansi-compatibility">SQL语法说明</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/参与社区/Linux 搭建 ByConity 开发环境">参与社区</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/基础使用手册/导入数据">基础使用手册</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/基础使用手册/导入数据">导入数据</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/导出数据">导出数据</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/数据可视化">数据可视化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/数据类型">数据类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/监控集群">监控集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/管理后台任务">管理后台任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/设计库表">设计库表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/连接客户端">连接客户端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/部署要求">部署要求</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/配置计算组">配置计算组</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/集群配置参数">集群配置参数</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/高级用户手册/事物和并发控制">高级用户手册</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_baW4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Njrt"><div class="docItemContainer_ZzVP"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HWXL" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_IT7R"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">基础使用手册</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">导入数据</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_GIgr theme-doc-toc-mobile tocMobile_JEhh"><button type="button" class="clean-btn tocCollapsibleButton_Q9up">On this page</button></div><div class="theme-doc-markdown markdown"><h1>导入数据</h1><p>文档类型：教程型</p><p>文档结构：教程目的，前置准备，分步骤讲解原理 &amp; 示例，相关文档推荐；</p><p>内容提要：</p><ol><li>支持哪些方式导入数据，导入方式上是否有建议（比如直接写入和合并 part 文件后 attach）</li><li>如何连接上游支持的数据源</li><li>如何查看数据导入情况</li><li>常见的导入报错该做什么</li></ol><h1>支持的数据源</h1><p>提供多种数据导入方案，可以针对不同的数据源进行选择不同的数据导入方式。</p><h2 class="anchor anchorWithStickyNavbar_er05" id="按场景划分">按场景划分<a href="#按场景划分" class="hash-link" aria-label="Direct link to 按场景划分" title="Direct link to 按场景划分">​</a></h2><p>数据源</p><p>导入方式</p><p>本地文件</p><p>流式导入数据(本地文件及内存数据)</p><p>HDFS</p><p>通过外部存储数据导入</p><p>Kafka</p><p>通过 Kafka 导入数据</p><p>通过 spark 导入</p><p>通过 Spark 导入外部数据</p><p>Mysql、Hive</p><p>通过 ByConity 访问外部数据源</p><h2 class="anchor anchorWithStickyNavbar_er05" id="支持的数据格式">支持的数据格式<a href="#支持的数据格式" class="hash-link" aria-label="Direct link to 支持的数据格式" title="Direct link to 支持的数据格式">​</a></h2><p>导入方式</p><p>支持的数据格式</p><p>HDFS</p><p>Parquet，ORC，csv，gzip</p><p>本地文件以及内存数据</p><p>snappy 压缩格式</p><p>json, csv, TSKV，Parquet，ORC</p><p>Kafka</p><p>csv, gzip,json</p><h1>导入方式</h1><h2 class="anchor anchorWithStickyNavbar_er05" id="流式导入数据本地文件及内存数据">流式导入数据(本地文件及内存数据)<a href="#流式导入数据本地文件及内存数据" class="hash-link" aria-label="Direct link to 流式导入数据(本地文件及内存数据)" title="Direct link to 流式导入数据(本地文件及内存数据)">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="方式一">方式一：<a href="#方式一" class="hash-link" aria-label="Direct link to 方式一：" title="Direct link to 方式一：">​</a></h3><p>方式一使用 VALUES 格式的常规语法，适合临时插入少量的数据用来测试：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO [db.]table [(c1, c2, c3...)] VALUES (v11, v12, v13), (v21, v22, v23), ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中，c1、c2、c3 是列字段声明，可忽略。VALUES 后紧跟的是由元组组成的代写入的数据，通过下标位与列字段声明一一对应。数据支持批量声明写入，多行数据之间使用逗号分隔。</p><p>例如，考虑该表：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE test.insert_select_testtable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `a` Int8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `b` String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `c` Int8,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `date` Date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = CnchMergeTree()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION by toYYYYMM(date)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY tuple()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO insert_select_testtable VALUES (1, &#x27;a&#x27;, 1,&#x27;2022-11-10&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在使用 VALUES 格式的语法写入数据时，支持加入表达式或者函数，例如：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO insert_select_testtable VALUES (1, &#x27;a&#x27;, 1, now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="方式二">方式二：<a href="#方式二" class="hash-link" aria-label="Direct link to 方式二：" title="Direct link to 方式二：">​</a></h3><p>方式二是使用指定格式的语法：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO [db.]table [(c1, c2, c3...)] FORMAT format_name data_set</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ByConity 支持多种数据格式，以常用的 CSV 格式写入为例：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO insert_select_testtable FORMAT CSV \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1, &#x27;a&#x27;, 1, &#x27;2022-11-10&#x27;\</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2, &#x27;b&#x27;, 2, &#x27;2022-11-11&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同时，还支持从文件向表中插入数据。例如：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO [db.]table [(c1, c2, c3)] FORMAT format_name INFILE file_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用上面的语句可以从客户端的文件上读取数据并插入表中，file_name 和 type 都是 String 类型，输入文件的格式一定要在 FORMAT 语句中设置。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="方式三">方式三：<a href="#方式三" class="hash-link" aria-label="Direct link to 方式三：" title="Direct link to 方式三：">​</a></h3><p>方式三是使用 SELECT 子句的形式，适合需要保存某张表结果并供后续查询的情况：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO [db.]table [(c1, c2, c3...)] SELECT ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">写入时与SELECT的列的对应关系是使用位置来进行对应的，尽管在SELECT表达式与INSERT中的名称是不同的。如果需要，会进行对应的类型转换。</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>通过 SELECT 子句可将查询结果写入数据表，假设需要将 insert_select_testtable_1 的数据写入 insert_select_testtable，则可以使用下面的语句：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO insert_select_testtable SELECT * from insert_select_testtable_1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在通过 SELECT 子句写入数据的时候，同样也支持加入表达式或者函数，例如：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO insert_select_testtable SELECT 1, &#x27;a&#x27;, 1, now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>虽然 VALUES 和 SELECT 子句的形式都支持声明表达式或函数，但是表达式和函数会带来额外的性能开销，从而导致写入性能下降。所以如果追求极致的写入性能。所以如果追求极致的写入性能，就应该避免使用它们。</p><h2 class="anchor anchorWithStickyNavbar_er05" id="通过外部存储数据导入">通过外部存储数据导入<a href="#通过外部存储数据导入" class="hash-link" aria-label="Direct link to 通过外部存储数据导入" title="Direct link to 通过外部存储数据导入">​</a></h2><p>ByConity 同样支持从本地或者 HDFS 上导入数据，例如：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO [db.]table [(c1, c2, c3)] FORMAT format_name INFILE &#x27;hdfs://ip:port/file_name&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="使用-kakfa-导入数据">使用 kakfa 导入数据<a href="#使用-kakfa-导入数据" class="hash-link" aria-label="Direct link to 使用 kakfa 导入数据" title="Direct link to 使用 kakfa 导入数据">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="功能定义">功能定义<a href="#功能定义" class="hash-link" aria-label="Direct link to 功能定义" title="Direct link to 功能定义">​</a></h3><p>CnchKafka 是 ByConity 基于社区 ClickHouse Kafka 表引擎自研实现的适配云原生架构的表引擎，用于高效快速地将用户数据从 Apache Kafka 实时导入 ByConity；其设计与实现既适配了云原生新架构，同时在社区实现基础上增强了部分功能。</p><p>CnchKafka 主要功能特点包括：</p><ul><li>提供基于云原生架构优势的自动容错能力，降低运维成本；</li><li>可扩展的消费能力：支持通过 SYSTEM 命令调节消费者数目，最高适配 topic 对应的 partition 数；</li><li>增强消费语义：依赖 Transaction 保证，通过引擎管理 offset 实现 Exactly-Once 消费语义；</li><li>消费性能：很大程度依赖用户表的 schema 复杂度，通常经验值 2k-2M 条/秒，吞吐 15MiB/s 左右；</li><li>支持多种数据类型，包括但不限于 Json、ProtoBuf、CSV 等；</li><li>支持记录消费日志，既方便排查问题，也提供了数据审计的能力。</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="实现原理">实现原理<a href="#实现原理" class="hash-link" aria-label="Direct link to 实现原理" title="Direct link to 实现原理">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="概述">概述<a href="#概述" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h4><p>CnchKafka 继承了社区的基本设计，即通过一个 &lt;CnchKafka 消费表、Materialized View 物化视图表、存储表 &gt; 三元组实现整个消费链路，其中：</p><ul><li>CnchKafka 消费表：负责订阅 Kafka topic 并消费消息；将得到的消息解析后写为 Block；</li><li>Materialized View 物化视图表：构建从消费表到存储表的数据通路，将 CnchKafka 消费的 Block 写入存储表，并提供简单的过滤功能；</li><li>存储表：支持 Cnch 多种 MergeTree 存储表。</li></ul><p>基本数据通路如下：</p><p><img loading="lazy" src="/assets/images/boxcnbeMipMsWmYggoqbR4DT88c-8f3b6d8f7092df4cbff90bfd5115de2c.png" width="852" height="492" class="img_Ne1E"></p><p>图中各组件是 ByConity 云原生架构部分涉及 CnchKafka 的组件，为避免读者不了解，此处对各组件做简单说明；但限于篇幅和重点，更详细的架构设计细节请参考架构文档。</p><ul><li><strong>Server</strong></li><li>应用接入层，所有查询和导入任务的入口；</li><li>轻量级设计，本身不做具体查询和导入，主要负责任务调度转发和元数据访问，包括：</li><li>预处理查询请求，从 Catalog 读取元数据，将原数据和查询 sql 下发查询节点，将查询结果返回上层（调用接口或用户等）；</li><li>管理导入任务：选择导入节点执行导入任务；</li><li>和 Catalog 交互，查询或更新元数据；</li><li>和 Resource Manager 交互，选择任务执行节点保证负载均衡；</li><li><strong>Virtual WareHouse</strong></li><li>计算层，所有查询和导入任务的执行节点，无状态服务；</li><li>支持租户独享，实现资源和数据隔离；</li><li>支持读写分离，查询和导入可创建和指定不同 Virtual WareHouse；</li><li><strong>Catalog</strong></li><li>KV 数据库，用于元数据管理，包括数据库表元信息、part 元信息等；</li><li>CnchKafka 消费 offset 也存储在 catalog；</li><li><strong>VFS</strong></li><li>底层存储，支持多种存储系统，包括 HDFS、S3 等。</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="kafkaconsumemanager">KafkaConsumeManager<a href="#kafkaconsumemanager" class="hash-link" aria-label="Direct link to KafkaConsumeManager" title="Direct link to KafkaConsumeManager">​</a></h4><p>每张 CnchKafka 消费表会在 Server 层启动一个 Manager 负责调度和管理所有的消费者任务。Manager 本身是 Server 端的一个常驻线程，通过 Server 的高可用和 DaemonManager 保证其服务稳定。</p><p>KafkaConsumeManager 主要实现和功能包括：</p><ul><li>根据配置的 consumer 数目将 topic partition 均匀分发到每个 consumer；</li><li>与 Catalog 交互，获取 partition 消费的 offset；</li><li>调度 consumer 到配置的 Virtual Warehouse 节点执行：</li><li>节点选择支持多种策略配置，保证负载均衡；</li><li>定期探活每个 consumer 任务，保证任务执行的稳定性。</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="kafkaconsumer">KafkaConsumer<a href="#kafkaconsumer" class="hash-link" aria-label="Direct link to KafkaConsumer" title="Direct link to KafkaConsumer">​</a></h4><p>每个 KafkaConsumer 实现为一个常驻线程在 Virtual Warehouse 节点执行，负责从指定的 topic partition 消费数据，转换为 part 写入 VFS，并将元信息提交回 Server 端写入 Catalog。主要特点：</p><ul><li>继承社区的攒批写入模式（每次消费周期默认 8 秒）；</li><li>每次消费过程通过 Transaction 保证原子性：</li><li>通过与 Server RPC 交互创建事务；</li><li>事务提交会同时提交写入的 part 元信息以及最新消费的 offset。</li></ul><p>单次消费执行流程可参考下图：</p><p><img loading="lazy" src="/assets/images/boxcnlEuwS4ogryA87WHPdDK1Md-d42dcff9e6716fe35060170db3994a06.png" width="852" height="580" class="img_Ne1E"></p><h4 class="anchor anchorWithStickyNavbar_er05" id="exactly-once">Exactly-Once<a href="#exactly-once" class="hash-link" aria-label="Direct link to Exactly-Once" title="Direct link to Exactly-Once">​</a></h4><p>与社区实现相比，CnchKafka 实现增强了消费语义，即从社区的 At-Least-Once 语义，升级为 Exactly-Once 语义。这主要得益于新架构 Transaction 事务的保证。</p><p>由于每轮消费都会通过事务管理，且每次提交数据元信息的同时提交对应的 offset。由于事务保证了提交的原子性，那么数据元信息和 offset 要么同时提交成功，要么都提交失败。</p><p>这样就保证了数据和 offset 始终一致，每次消费重启都从上次提交的 offset 位置继续消费，从而实现了 Exactly-Once。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="自动容错实现">自动容错实现<a href="#自动容错实现" class="hash-link" aria-label="Direct link to 自动容错实现" title="Direct link to 自动容错实现">​</a></h4><p>CnchKafka 整体容错策略采取<strong>快速失败</strong>方式，即：</p><ul><li>KafkaConsumeManager 定期探活 consumer 任务，探活失败，立即拉起一个新的 consumer；</li><li>KafkaConsumer 每次执行中，与 Server RPC 的两次交互（创建事务和提交事务）都会向 Manager 校验自身的有效性，如果校验失败（比如 Manager 已经拉起了一个新的 consumer 等），会主动 kill 自己。</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="使用指南">使用指南<a href="#使用指南" class="hash-link" aria-label="Direct link to 使用指南" title="Direct link to 使用指南">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="建表">建表<a href="#建表" class="hash-link" aria-label="Direct link to 建表" title="Direct link to 建表">​</a></h4><p>创建 CnchKafka 消费表和社区原生建 Kafka 表类似，需要通过 Setting 参数配置 Kafka 数据源及消费参数。示例如下：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE kafka_test.cnch_kafka_consume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `i` Int64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `ts` DateTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = CnchKafka()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SETTINGS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_broker_list = &#x27;10.10.10.10:9092&#x27;,  -- replace with your own broker list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_topic_list = &#x27;my_kafka_test_topic&#x27;, -- topic name to subcribe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_group_name = &#x27;hansome_boy_consume_group&#x27;, -- your consumer-group name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_format = &#x27;JSONEachRow&#x27;, -- always be json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_row_delimiter = &#x27;\n&#x27;, -- always be \n</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_num_consumers = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>（Setting 参数说明及其他更多参数支持请参考下方说明）</p><p>由于 Kafka 消费设计需要三张表，所以还需要同步创建另外两张表。</p><p>首先创建存储表（以 CnchMergeTree 为例）：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE kafka_test.cnch_store_kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `i` Int64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `ts` DateTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = CnchMergeTree</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY toDate(ts)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY ts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最后创建物化视图表（必须 Kafka 表和存储表创建成功后才能创建）：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE MATERIALIZED VIEW kafka_test.cnch_kafka_view</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TO kafka_test.cnch_store_kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `i` Int64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    `ts` DateTime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * -- you can add virtual columns here if you need</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM kafka_test.cnch_kafka_consume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果你有对应 topic 的消费权限，那么三张表创建好以后，消费就会自动开始执行。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="虚拟列支持">虚拟列支持<a href="#虚拟列支持" class="hash-link" aria-label="Direct link to 虚拟列支持" title="Direct link to 虚拟列支持">​</a></h4><p>有时候业务需要获取 Kafka 消息的元数据（e.g. 消息的 partition, offset 等）。此时可以使用 virtual columns 功能来满足这个需求。virtual columns 不需要在建表的时候指定，是表引擎本身的属性。可以放到 VIEW 表的 SELECT 语句中存储到底表中（当底表添加了对应列）：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _topic,    -- String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _partition,    -- UInt64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _key,    -- String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _offset,    -- UInt64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    _content,  -- String: 完整的消息内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    *    -- 正常列可以通过*展开，虚拟列则不能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM kafka_test.cnch_kafka_consume</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="setting-参数说明">Setting 参数说明<a href="#setting-参数说明" class="hash-link" aria-label="Direct link to Setting 参数说明" title="Direct link to Setting 参数说明">​</a></h4><p><strong>参数名</strong></p><p><strong>类型</strong></p><p><strong>必填/默认值</strong></p><p><strong>说明</strong></p><p>kafka_cluster / kafka_broker_list</p><p>String</p><p>必填</p><p>公司内部 Kafka 集群；</p><p>社区版本 Kafka 请使用 <code>kafka_broker_list</code> 参数</p><p>kafka_topic_list</p><p>String</p><p>必填</p><p>可以多个，逗号分隔</p><p>kafka_group_name</p><p>String</p><p>必填</p><p>consumer group name，消费组</p><p>kafka_format</p><p>String</p><p>必填</p><p>消息格式；目前最常用 JSONEachRow</p><p>kafka_row_delimiter</p><p>String</p><p>&#x27;\0&#x27;</p><p>一般使用 &#x27;\n&#x27;</p><p>kafka_num_consumers</p><p>UInt64</p><p>1</p><p>消费者个数，建议不超过 topic 中最大 partition 数目</p><p>kafka_max_block_size</p><p>UInt64</p><p>65536</p><p>写入 block_size，上限 1M</p><p>kafka_max_poll_interval_ms</p><p>Milliseconds</p><p>7500</p><p>the max time to poll from broker each iteration</p><p>kafka_schema</p><p>String</p><p>&quot;&quot;</p><p>schema 文件设置参数，以文件名 + 冒号 + 消息名格式设置</p><p>如： <code>schema.proto:MyMessage</code></p><p>kafka_format_schema_path</p><p>String</p><p>&quot;&quot;</p><p>远端 schema 文件路径(不含文件名)设置参数，目前只支持 hdfs.</p><p>（如果没有设置这个参数，将从配置文件设置的默认路径读取）</p><p>kafka_protobuf_enable_multiple_message</p><p>bool</p><p>true</p><p>设置为 true，表示可以从一条 kafka 消息中读取多个 protobuf 的 message，彼此以各自长度为间隔</p><p>kafka_protobuf_default_length_parser</p><p>bool</p><p>false</p><p>仅在 <code>kafka_protobuf_enable_multiple_message</code> 为 true 生效：true 表示消息头部有变量记录长度；false 表示用一个固定的 8 字节作为头部记录长度。</p><p>kafka_extra_librdkafka_config</p><p>Json format string</p><p>&quot;&quot;</p><p>(More params refer to <a href="https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md#:~:text=see%20dedicated%20API-,ssl.ca.location,-*" target="_blank" rel="noopener noreferrer">here</a>)</p><p>其他 rdkafka 支持的参数，通常用于鉴权</p><ul><li><strong>SCRAM</strong>: &quot;{&quot;sasl.mechanisms&quot;:&quot;SCRAM-SHA-512&quot;,&quot;sasl.password&quot;:&quot;<strong>*<!-- -->&quot;,&quot;sasl.username&quot;:&quot;bytehouse-dev&quot;,&quot;security.protocol&quot;:&quot;sasl_ssl&quot;,&quot;ssl.ca.location&quot;:&quot;</strong>&quot;}&quot;</li><li><strong>PLAIN</strong>: &quot;{&quot;sasl.mechanisms&quot;:&quot;PLAIN&quot;,&quot;sasl.password&quot;:&quot;admin&quot;,&quot;sasl.username&quot;:&quot;admin&quot;,&quot;security.protocol&quot;:&quot;sasl_plaintext&quot;}&quot;</li></ul><p>cnch_vw_write</p><p>String</p><p>&quot;vw_write&quot;</p><p>配置消费使用 Virtual WareHouse，consumer 任务将被调度到配置的 Virtual Warehouse 节点执行</p><p>kafka_cnch_schedule_mode</p><p>String</p><p>&quot;random&quot;</p><p>ConsumeManager 调度 consumer 任务时候采取的调度策略，目前支持：random, hash, and <strong>least_consumers；</strong>如果是独立 vw 或消费者数目大于 10，推荐使用<strong> least_consumers</strong></p><h4 class="anchor anchorWithStickyNavbar_er05" id="修改消费参数">修改消费参数<a href="#修改消费参数" class="hash-link" aria-label="Direct link to 修改消费参数" title="Direct link to 修改消费参数">​</a></h4><p>支持通过 ALTER 命令快速修改 Setting 参数，主要用于调整消费者数目等提升消费能力。</p><p>命令：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">ALTER TABLE &lt;cnch_kafka_name&gt; MODIFY SETTING &lt;name1&gt; = &lt;value1&gt;, &lt;name2&gt; = &lt;value2&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>该命令执行会自动重启消费任务。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="手动启停消费">手动启停消费<a href="#手动启停消费" class="hash-link" aria-label="Direct link to 手动启停消费" title="Direct link to 手动启停消费">​</a></h4><p>在一些场景中用户可能需要手动停止消费，随后手动恢复；我们提供了对应的 SYSTEM 命令实现：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEM START/STOP/RESTART CONSUME &lt;cnch_kafka_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意：START/STOP 命令会将对应状态持久化到 Catalog，因此在执行 STOP 命令后，如果不执行 START，即使服务重启，消费任务也不会恢复。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="重置-offset">重置 offset<a href="#重置-offset" class="hash-link" aria-label="Direct link to 重置 offset" title="Direct link to 重置 offset">​</a></h4><p>由于 CnchKafka 的 offset 由引擎自身管理和保存，当用户需要重启 offset 时，我们同样实现了 SYSTEM 命令操作。具体支持以下三种方式：</p><h5 class="anchor anchorWithStickyNavbar_er05" id="a-重置到特殊位置最新位置起始位置">A 重置到特殊位置：最新位置/起始位置<a href="#a-重置到特殊位置最新位置起始位置" class="hash-link" aria-label="Direct link to A 重置到特殊位置：最新位置/起始位置" title="Direct link to A 重置到特殊位置：最新位置/起始位置">​</a></h5><p>命令：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEM RESET CONSUME OFFSET &#x27;{&quot;database_name&quot;:&quot;XXX&quot;, &quot;table_name&quot;: &quot;XXX&quot;, &quot;offset_value&quot;:-1}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可能的特殊位置的 value 值：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">    enum Offset {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OFFSET_BEGINNING = -2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OFFSET_END = -1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OFFSET_STORED = -1000,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OFFSET_INVALID = -1001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_er05" id="b-按时间戳重置">B 按时间戳重置<a href="#b-按时间戳重置" class="hash-link" aria-label="Direct link to B 按时间戳重置" title="Direct link to B 按时间戳重置">​</a></h5><p>（版本要求 &gt;= cnch-1.4）命令：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEM RESET CONSUME OFFSET &#x27;{&quot;database_name&quot;:&quot;XXX&quot;, &quot;table_name&quot;: &quot;XXX&quot;, &quot;timestamp&quot;:1646125258000}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>其中 timestamp 的值应该为 Kafka 侧数据有效期内的某个时间的时间戳，且为毫秒级。</p><h5 class="anchor anchorWithStickyNavbar_er05" id="c-指定-offset-具体-value">C 指定 offset 具体 value<a href="#c-指定-offset-具体-value" class="hash-link" aria-label="Direct link to C 指定 offset 具体 value" title="Direct link to C 指定 offset 具体 value">​</a></h5><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">system reset consume offset &#x27;{&quot;database_name&quot;:&quot;XXX&quot;, &quot;table_name&quot;: &quot;XXX&quot;, &quot;topic_name&quot;: &quot;XXX&quot;, &quot;offset_values&quot;:[{&quot;partition&quot;:0, &quot;offset&quot;:100}, {&quot;partition&quot;:10, &quot;offset&quot;:101}]}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>指定特定 topic partition 到特定 offset value，比较少见。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="运维手册">运维手册<a href="#运维手册" class="hash-link" aria-label="Direct link to 运维手册" title="Direct link to 运维手册">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="常见消费性能调优">常见消费性能调优<a href="#常见消费性能调优" class="hash-link" aria-label="Direct link to 常见消费性能调优" title="Direct link to 常见消费性能调优">​</a></h4><p>当消费持续出现 lag，通常为消费能力不足。CnchKafka 建表默认 1 个消费，单次消费写入最大 block size 为 65536. 当消费能力不足时，优先调整消费者和 block-size 参数。调整方式参考上文<strong>修改消费参数</strong></p><h5 class="anchor anchorWithStickyNavbar_er05" id="调整-max-block-size">调整 max-block-size<a href="#调整-max-block-size" class="hash-link" aria-label="Direct link to 调整 max-block-size" title="Direct link to 调整 max-block-size">​</a></h5><ul><li>该参数直接影响消费内存使用，值越大所需内存越大。对于一些单条数据较大的消费表，谨慎调整该参数，避免爆内存。（上限为 1M）</li><li>当用户对数据延时要求不高，且数据量大 内存充足时，可同步调整此参数以及“kafka_max_poll_interval_ms”参数，让每一轮消费时间增加，每次写入的 part 变大，降低 MERGE 压力，提升查询性能。</li></ul><h5 class="anchor anchorWithStickyNavbar_er05" id="调整-num_consumers">调整 num_consumers<a href="#调整-num_consumers" class="hash-link" aria-label="Direct link to 调整 num_consumers" title="Direct link to 调整 num_consumers">​</a></h5><ul><li>该参数上限为消费 topic 对应的 partition 数目。</li><li>在消费无 lag 情况下，尽可能减少此参数（即避免无意义增大此参数），减少资源使用，同时避免消费产生过多碎 part，增大 MERGE 压力，且不利于查询。</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="用于辅助排查的系统表">用于辅助排查的系统表<a href="#用于辅助排查的系统表" class="hash-link" aria-label="Direct link to 用于辅助排查的系统表" title="Direct link to 用于辅助排查的系统表">​</a></h4><h5 class="anchor anchorWithStickyNavbar_er05" id="消费事件cnch_systemcnch_kafka_log">消费事件：cnch_system.cnch_kafka_log<a href="#消费事件cnch_systemcnch_kafka_log" class="hash-link" aria-label="Direct link to 消费事件：cnch_system.cnch_kafka_log" title="Direct link to 消费事件：cnch_system.cnch_kafka_log">​</a></h5><p>kakfa_log 表记录了一些消费的基本事件，开启需要在 config.xml 中配置 kafka_log 项（server&amp;worker 均需配置），重启之后生效。</p><p>kafka_log 在 Virtual Warehouse 由 consumer 任务写入，实时汇聚到全局的 cnch_system.cnch_kafka_log 表中，实现从 Server 段查看所有消费表的消费记录。</p><p><strong>字段说明</strong></p><p><strong>列名</strong></p><p><strong>类型</strong></p><p><strong>说明</strong></p><p>event_type</p><p>Enum8</p><p>见下表</p><p>event_date</p><p>Date</p><p>时间发生日期。分区字段，建议每次查询都带上。</p><p>event_time</p><p>DateTime</p><p>时间发生时间，单位秒</p><p>duration_ms</p><p>UInt64</p><p>事件持续时间，单位秒</p><p>cnch_database</p><p>String</p><p>CnchKafka 库名</p><p>cnch_table</p><p>String</p><p>CnchKafka 表名</p><p>database</p><p>String</p><p>consumer 任务库名（目前同 cnch_database）</p><p>table</p><p>String</p><p>consumer 任务表名（通常为 cnch_table 加时间戳及消费者编号后缀）</p><p>consumer</p><p>String</p><p>消费者编号</p><p>metric</p><p>UInt64</p><p>消费行数</p><p>has_error</p><p>UInt8</p><p>1 代表有异常；0 代表无异常。</p><p>exception</p><p>String</p><p>异常说明，</p><p><strong>事件说明</strong></p><p><strong>UInt8 值</strong></p><p><strong>String 值</strong></p><p><strong>说明</strong></p><p>1</p><p>POLL</p><p>metric 表示消费了多少条数据，duration_ms 覆盖了一次完整的消费流程，包含 WRITE 的时间。</p><p>2</p><p>PARSE_ERROR</p><p>metric 表示解析出错的消费条数，如果有多条解析出错，仅挑选一条打印出来。</p><p>3</p><p>WRITE</p><p>metric 表示写入数据的行数，duration_ms 基本上等同于数据持久化的时间</p><p>4</p><p>EXCEPTION</p><p>消费过程的异常。常见的有：鉴权异常，数据持久化失败，VIEW SELECT 执行失败。</p><p>5</p><p>EMPTY_MESSAGE</p><p>空消息条数。</p><p>6</p><p>FILTER</p><p>写入阶段被过滤的数据。</p><p>7</p><p>COMMIT</p><p>最后事务提交记录，只有该条记录才表示数据写入成功，可作为数据审计标准</p><h5 class="anchor anchorWithStickyNavbar_er05" id="消费状态systemcnch_kafka_tables">消费状态：system.cnch_kafka_tables<a href="#消费状态systemcnch_kafka_tables" class="hash-link" aria-label="Direct link to 消费状态：system.cnch_kafka_tables" title="Direct link to 消费状态：system.cnch_kafka_tables">​</a></h5><p>kafka_tables 记录了 CnchKafka 表的实时状态，默认开始，为内存表；</p><p><strong>字段说明</strong></p><p><strong>字段名</strong></p><p><strong>数据类型</strong></p><p><strong>说明</strong></p><p>database</p><p>String</p><p>数据库名</p><p>name</p><p>String</p><p>Kafka 表名</p><p>uuid</p><p>String</p><p>kafka 表唯一标识 UUID</p><p>kafka_cluster</p><p>String</p><p>kafka 集群</p><p>topics</p><p>Array(String)</p><p>消费 topic 列表</p><p>consumer_group</p><p>String</p><p>所属消费组</p><p>num_consumers</p><p>UInt32</p><p>当前实际正在执行的消费者数目</p><p>consumer_tables</p><p>Array(String)</p><p>各个消费者对应的数据表名</p><p>consumer_hosts</p><p>Array(String)</p><p>各个消费者分发到的执行节点</p><p>consuemr_partitions</p><p>Array(String)</p><p>各个消费者分配到的需要消费的 partition</p><h4 class="anchor anchorWithStickyNavbar_er05" id="常见排查消费异常记录">常见排查消费异常记录<a href="#常见排查消费异常记录" class="hash-link" aria-label="Direct link to 常见排查消费异常记录" title="Direct link to 常见排查消费异常记录">​</a></h4><h5 class="anchor anchorWithStickyNavbar_er05" id="查看-cnchkafka-消费表实时状态">查看 CnchKafka 消费表实时状态<a href="#查看-cnchkafka-消费表实时状态" class="hash-link" aria-label="Direct link to 查看 CnchKafka 消费表实时状态" title="Direct link to 查看 CnchKafka 消费表实时状态">​</a></h5><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM system.cnch_kafka_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE database = &lt;database_name&gt; AND name = &lt;cnch_kafka_table&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_er05" id="查看最近消费记录">查看最近消费记录<a href="#查看最近消费记录" class="hash-link" aria-label="Direct link to 查看最近消费记录" title="Direct link to 查看最近消费记录">​</a></h5><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM cnch_system.cnch_kafka_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE event_date = today()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AND cnch_database = &lt;database_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AND cnch_table = &lt;cnch_kafka_table&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AND event_time &gt; now() - 600 -- 最近十分钟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY event_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_er05" id="按小时统计当天消费记录">按小时统计当天消费记录<a href="#按小时统计当天消费记录" class="hash-link" aria-label="Direct link to 按小时统计当天消费记录" title="Direct link to 按小时统计当天消费记录">​</a></h5><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> toHour(event_time) as hour,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> sumIf(metric, event_type = &#x27;POLL&#x27;) as poll_rows,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> sumIf(metric, event_type = &#x27;PARSE_ERROR&#x27;) as error_rows,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> sumIf(metric, event_type = &#x27;COMMIT&#x27;) as commit_rows</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FROM cnch_system.cnch_kafka_log</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WHERE event_date = today()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AND cnch_database = &lt;database_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> AND cnch_table = &lt;cnch_kafka_table&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">GROUP BY hour</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY hour</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_er05" id="通过-spark-导入外部数据">通过 Spark 导入外部数据<a href="#通过-spark-导入外部数据" class="hash-link" aria-label="Direct link to 通过 Spark 导入外部数据" title="Direct link to 通过 Spark 导入外部数据">​</a></h2><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">  使用part writer工具导入ByConity，part writer工具可以不经过ByConity引擎，直接将数据文件转化为part文件。使用part writer可以实现ByConity查询与构建分离，一定程度缓解数据导入和查询的资源竞争，提高查询性能。目前，part writer及ByConity对应的加载part文件功能的开发基本完成，下面介绍如何使用part writer将数据导入到ByConity。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   （1）使用part writer生成part文件</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>part writer 接收一个 sql 语句作为参数，用户通过 sql 语句指定源数据文件、数据文件格式、数据 schema、part 文件保存路径等详细信息，使用方式如下：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">./part_writer &quot;load CSV file &#x27;/path/to/data/test.csv&#x27; as table db.tablename(col1 UInt64, col2 String, col3 Nullable(String)) partition by col1 order by (col2, col3) location &#x27;/path/to/dest/&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>示例 SQL 中，</p><ol><li>‘CSV’指定源数据文件格式；此外，part writer 还可使用 CSVWithNames， JSONEachRow 等多种 clickhouse 原生支持的数据文件格式。</li><li>&#x27;/path/to/data/test.csv&#x27; 指定了源数据文件；支持从本地和 hdfs 读取源数据。如使用 hdfs 数据文件，指定路径为：‘hdfs://host:port/path/to/data/file’;</li><li>&#x27;/path/to/dest/&#x27;指定 part 文件写入的目标文件夹；支持将 part 文件直接写到 hdfs 上，ByConity 可以从 hdfs 上拉取并加载 part 文件。</li><li>as table 指定了插入数据的 schema 信息</li><li>partition by 和 order by 分别指定了数据表的分区键和排序键，多个键之间使用逗号进行分割并且需要用圆括号包裹， 如: partition by (name, id)。</li><li>ByConity 特殊选项，settings cnch=1，用于将生成的 part 直接 dump 成 ByConity 的 part 格式并写入 location 选项指定的 hdfs 路径。</li></ol><p>（2）part 文件导入 ByConity</p><p>生成好的 part 文件可以直接 copy 到 ByConity 表对应的数据文件路径下，然后通过重启 ByConity server 加载；</p><p>也可以将 part 文件目录 copy 到表的 detached 目录下，通过 attach 命令加载 part 文件, 如</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">alter table test attach part &#x27;partfile&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果使用 part writer 生成 part 文件时指定了直接上传到 hdfs，可以执行如下命令：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">system fetch parts into db.table &#x27;hdfs://host:port/path/to/part/&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ByConity 将自动从 hdfs 路径下拉取 part 文件并进行加载。</p><p>ByConity attach 语法：</p><p>用于将 dump 到 hdfs 的 parts 导入到目标表：</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">alter table test attach parts from &#x27;/hdfs/path/to/dumped/dir&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同时，形式四还支持 spark 导入：</p><p>实际应用场景下，需要往 ByConity 集群导入大量数据，可以考虑使用 spark。首先从外部将数据读入 spark dataset；然后根据 sharding key 对 dataset 进行 repartition，保证将要发送到不同 ByConity 节点到数据落在不同的 partition 上（可能需要根据实际情况，调整 spark.sql.shuffle.partitions 参数使 partition 不小于 ByConity 主节点数）；对于每个 partition， 首先通过调用 part writer 生成 part 文件，并指定 part 文件上传到 hdfs，然后通过向对应 ByConity 节点发送 http 请求，通知 ByConity 加载 part 文件。数据流图如下：</p><p><img loading="lazy" src="/assets/images/boxcnlSkMX0zkWno7WT7250zU1f-34e6227c68a2d8f422871470a960b591.png" width="835" height="330" class="img_Ne1E"></p><h2 class="anchor anchorWithStickyNavbar_er05" id="通过-byconity-访问外部数据源">通过 ByConity 访问外部数据源<a href="#通过-byconity-访问外部数据源" class="hash-link" aria-label="Direct link to 通过 ByConity 访问外部数据源" title="Direct link to 通过 ByConity 访问外部数据源">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="mysql">MySQL<a href="#mysql" class="hash-link" aria-label="Direct link to MySQL" title="Direct link to MySQL">​</a></h3><p><code>MySQL</code> 引擎允许用户通过 ByConity 访问 MySQL 表，并可以进行 SELECT 和 INSERT 查询。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="在-mysql-中创建表">在 MySQL 中创建表<a href="#在-mysql-中创建表" class="hash-link" aria-label="Direct link to 在 MySQL 中创建表" title="Direct link to 在 MySQL 中创建表">​</a></h4><ul><li>创建 database</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE DATABASE db1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>在 mysql 中创建表</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE db1.table1(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id Int,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    column1 VARCHAR(255)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>插入一些数据</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO db1.table1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (id, column1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (1, &#x27;mysql-ab&#x27;),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (2, &#x27;mysql-cd&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>在 mysql 中创建 user 以在 ByConity 中连接 mysql</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE USER &#x27;mysql_byconity&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;Password123!&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>授予权限。(这里为了展示，授予了 <code>mysql_byconity</code> 用户 admin 权限)</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">GRANT ALL PRIVILEGES ON *.* TO &#x27;mysql_byconity&#x27;@&#x27;%&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="在-byconity-中创建-mysql-表">在 ByConity 中创建 MySQL 表<a href="#在-byconity-中创建-mysql-表" class="hash-link" aria-label="Direct link to 在 ByConity 中创建 MySQL 表" title="Direct link to 在 ByConity 中创建 MySQL 表">​</a></h4><p>Now let&#x27;s create a ByConity table that uses the <strong>MySQL</strong> table engine:</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE mysql_table1 (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id UInt64,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  column1 String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = MySQL(&#x27;mysql-host.domain.com&#x27;,&#x27;db1&#x27;,&#x27;table1&#x27;,&#x27;mysql_byconity&#x27;,&#x27;Password123!&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>MySQL</code> 引擎的参数如下表：</p><p>参数</p><p>描述</p><p>例子</p><p>host</p><p>域名或 IP:Port</p><p>mysql-host.domain.com</p><p>database</p><p>mysql 数据库名</p><p>db1</p><p>tabele</p><p>mysql 表名</p><p>table1</p><p>user</p><p>连接 mysql 的用户</p><p>mysql_byconity</p><p>password</p><p>连接 mysql 的密码</p><p>Password123!</p><h4 class="anchor anchorWithStickyNavbar_er05" id="在-byconity-中测试连接-mysql-表">在 ByConity 中测试连接 mysql 表<a href="#在-byconity-中测试连接-mysql-表" class="hash-link" aria-label="Direct link to 在 ByConity 中测试连接 mysql 表" title="Direct link to 在 ByConity 中测试连接 mysql 表">​</a></h4><ul><li>测试 SELECT 查询</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">select * from mysql_table1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/assets/images/boxcnJv89B9UChc3nI0EPHoba6c-fa2c29d57ba43284b475b4cd8ea404f6.png" width="1310" height="416" class="img_Ne1E"></p><ul><li>测试 INSERT 查询</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INSERT INTO mysql_table1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (id, column1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">VALUES</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (3, &#x27;byconity-test&#x27;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>在 MySQL 中验证从 ByConity 中插入的数据</li></ul><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">mysql&gt; select id, column1 from db1.table1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/assets/images/boxcnQdV8Jpg8jcqEKwAOjONxkh-8eae2b77e5168bc6c15fdbb742018db9.png" width="1368" height="336" class="img_Ne1E"></p><h3 class="anchor anchorWithStickyNavbar_er05" id="hive">Hive<a href="#hive" class="hash-link" aria-label="Direct link to Hive" title="Direct link to Hive">​</a></h3><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CnchHive为ByConity提供的一种表引擎，支持使用外表的方式进行联邦查询，用户无需通过数据导入，可以直接进行数据查询加速。</span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="使用">使用：<a href="#使用" class="hash-link" aria-label="Direct link to 使用：" title="Direct link to 使用：">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="实例-1构建-hive-表的全集">实例 1：构建 hive 表的全集<a href="#实例-1构建-hive-表的全集" class="hash-link" aria-label="Direct link to 实例 1：构建 hive 表的全集" title="Direct link to 实例 1：构建 hive 表的全集">​</a></h4><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">--创建hive外表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client_ip   String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request     String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  status_code INT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  object_size INT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = CnchHive(&#x27;psm&#x27;, &#x27;hive_database_name&#x27;, &#x27;hive_table_name&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY date;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--参数说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--psm：hivemetastore psm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hive_database_name：hive表database name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hive_table_name：hive表table name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--查询hive外表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select * from  t where xxx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="实例-2构建-hive-表的子集">实例 2：构建 hive 表的子集<a href="#实例-2构建-hive-表的子集" class="hash-link" aria-label="Direct link to 实例 2：构建 hive 表的子集" title="Direct link to 实例 2：构建 hive 表的子集">​</a></h4><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client_ip   String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request     String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = CnchHive(&#x27;psm&#x27;, &#x27;hive_database_name&#x27;, &#x27;hive_table_name&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--参数说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--psm：hivemetastore psm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hive_database_name：hive表database name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hive_table_name：hive表table name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--查询hive外表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select * from  t where xxx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="实例-3hive-bucket-表构建">实例 3：hive bucket 表构建<a href="#实例-3hive-bucket-表构建" class="hash-link" aria-label="Direct link to 实例 3：hive bucket 表构建" title="Direct link to 实例 3：hive bucket 表构建">​</a></h4><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  client_ip   String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  request     String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  device_id   String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  server_time String,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  date String</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ENGINE = CnchHive(&#x27;psm&#x27;, &#x27;hive_database_name&#x27;, &#x27;hive_table_name&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PARTITION BY date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CLUSTER BY device_id INTO 65536 BUCKETS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY server_time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SETTINGS cnch_vw_default =&#x27;vw_default&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--参数说明：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--psm：hivemetastore psm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hive_database_name：hive表database name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--hive_table_name：hive表table name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--查询hive外表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select * from  t where xxx;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>说明：</p><ul><li>外表列</li><li>列名需要与 hive 表一一对应</li><li>列的顺序不需要与 hive 一一对应</li><li>可以只选择 hive 表中的部分列，但分区列必须要全部包含。</li><li>外表列的分区需要通过 partition by 语句指定，同时需要与普通列一样定义到描述列表中。</li><li>当 Hive 表为 bucket 表时，建 CnchHive 引擎时需指定分桶列以及分桶数量。（CLUSTER BY xxx INTO xxx BUCKETS ）</li><li>当 Hive 表中有 ORDER BY 字段，建 CnchHive 引擎时需指定 ORDER BY 字段。</li><li>ENGINE 指定为 CnchHive</li><li>引擎参数</li><li>psm：hivemetastore psm</li><li>hive_database_name：指定 hive 中的数据库</li><li>hive_table_name：指定 hive 中的表，不支持 view。</li><li>支持的列类型对应关系如下表：</li></ul><p>hive 列类型</p><p>CnchHive 列类型</p><p>描述</p><p>INT/INTERGER</p><p>INT/INTERGER</p><p>BIGINT</p><p>BIGINT</p><p>TIMESTAMP</p><p>DateTime</p><p>STRING</p><p>String</p><p>VARCHAR</p><p>FixedString</p><p>内部转换为 FixedString</p><p>CHAR</p><p>FixedString</p><p>内部转换为 FixedString</p><p>DOUBLE</p><p>DOUBLE</p><p>FLOAT</p><p>FLOAT</p><p>DECIMAL</p><p>DECIMAL</p><p>MAP</p><p>Map</p><p>ARRAY</p><p>Array</p><p>说明：</p><ul><li>hive 表 schema 变更不会自动同步，需要在 Clickhouse 中重建 hive 外表</li><li>当前 hive 存储格式仅支持 Parquet</li><li>当前 CnchHive 不支持 insert、alter 操作</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="settings">SETTINGS<a href="#settings" class="hash-link" aria-label="Direct link to SETTINGS" title="Direct link to SETTINGS">​</a></h4><p>cnch_vw_default：用于指定 vw。</p><p>max_read_row_group_threads：用于指定并发读取 Parquet row group 的并发数量。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="运维手册-1">运维手册<a href="#运维手册-1" class="hash-link" aria-label="Direct link to 运维手册" title="Direct link to 运维手册">​</a></h4><p>关键字</p><p>解决办法</p><p>DB::Exception: Can not insert NULL data into non-nullable column &quot;name&quot;</p><p>列字段添加 Nullable 属性。</p><p>DB::Exception: The hive type is not match in cnch.</p><p>CnchHive schema type 与 Hive schema 不匹配。</p><p>DB::Exception: column name xxx doesn&#x27;t match.</p><p>CnchHive schema name 与 Hive schema 不匹配。</p><p>DB::Exception: CnchHive only support parquet format. Current format is org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat.</p><p>CnchHive 目前仅支持存储格式为 Parquet。</p><p>DB::Exception: No available nnproxy xxx.</p><p>HiveMetastore 的 psm 有问题，需 check HiveMetastore psm 是否可访问。</p><h1>常见报错及处理</h1><p>关键字</p><p>原因</p><p>解决办法</p><p>Too many map keys in table</p><p>(more than 10000)</p><p>Map 列中 key 种类超 10000</p><p>超 10000 则无法导入，请导入数据减少 map key 数量</p><p>Memory limit (total)</p><p>导入过程中内存超限制</p><p>Cannot parse JSON</p><p>json 中数据类型与 clickhouse 的不符</p><p>请用户检查上游生成数据类型是否匹配；</p><p>Duplicate field found while parsing JSONEachRow format: hour</p><p>json 数据有字段重复，这里的重复字段是 hour，即&quot;format:&quot;后的就是重复字段</p><p>检查上游数据是否正确，配置是否正确</p><p>HDFS json size xxx &gt; 1099511627776</p><p>导入数据太大(1T)，禁止导入</p><p>减少导入数据量</p><p>Unable to parse hdfs json file</p><p>hdfs 中数据格式错误</p><p>请用户检查 hdfs 中文件是否为合法的 json</p><p>DB::Exception: Error while reading parquet data: IOError: definition level exceeds maximum. Stack trace</p><p>hdsf 文件错误读取错误，多数为丢块等造成。</p><p>需要重新生产 HDFS 文件</p><p>DB::Exception: Cannot parse string &#x27;time=&quot;2021-11-12&#x27; as Date: syntax error at position 10 (parsed just &#x27;time=&quot;2021&#x27;). Note: there are toDateOrZero and toDateOrNull functions, which returns zero/NULL instead of throwing exception.: while pushing to view</p><p>这种情况是用户 topic 中有脏数据；Kafka 表消费的时候按 string 正常解析；但是写入底表通过 toDate 等函数转换发现不合法，导致写入失败阻塞消费</p><p>1.临时可修改 VIEW 表，过滤脏数据；</p><p>2.用户上游添加数据清洗和保护机制</p><p>3.Kafka 表解析与底表保持一致，不建议在写入阶段再转换，Kafka 解析失败可以丢弃脏数据，不阻塞整个消费</p><p>Code: 1001, type: cppkafka::Exception, e.what() = Failed to create consumer handle: consumer regist error, please check output!</p><p>打开 trace 日志，查看 Kafka 侧具体报错信息</p><p>根据报错信息处理</p><p>Code: 49, e.displayText() = DB::Exception: Check dependencies failed for</p><p>VIEW 表找不到</p><p>重建 VIEW 表</p><p>Code: 6001. DB::Exception: DB::Exception: Cannot get metadata of table XXX by UUID : XXX.</p><p>执行 ALTER TABLE 命令时报错，cnch 表是和 server 绑定，这个是由于没在表对应 server 执行导致</p><p>先查询 system.cnch_table_host 获得该表对应的 server，然后在对应 server 执行</p><p>No space left on device: while pushing to view</p><p>磁盘用满</p><p>清理磁盘</p><h1>导入参数调优</h1><h2 class="anchor anchorWithStickyNavbar_er05" id="直接写入方式调优">直接写入方式调优<a href="#直接写入方式调优" class="hash-link" aria-label="Direct link to 直接写入方式调优" title="Direct link to 直接写入方式调优">​</a></h2><p>在使用 INSERT VALUES, INSERT INFILE 或者 PartWriter 工具写入时，最后生成的 Part 数量会影响写入 HDFS 的次数进而影响写入整体的耗时，因此应当尽量减少 Part 的数量。直接写入的流程如下：</p><ul><li>读取部分文件数据</li><li>将这部分数据按照 PartitionBy 进行切分</li><li>将这部分数据按照 ClusterBy 进行切分</li><li>将切分完的数据写成新的 Part 并写入 HDFS</li></ul><p>调优手段：</p><ol><li>为了减少 Part 的数量，我们可以将文件中具有相同的分区和 Bucket 的数据排列在一起，这样每次读取一些新的数据后，生成的 Part 数量会尽可能少。可以将数据按照分区相同，分区内 Bucket 相同的要求进行排序，Bucket 的计算规则是：</li></ol><ul><li>如果没有指定 SPLIT_NUMBER，会将 ClusterByKey 所使用的列计算 SipHash 后对 BucketNumber 取模得到 BucketNumber</li><li>如果指定了 SPLIT_NUMBER</li><li>计算 SplitValue</li><li>如果 ClusterBy 某一列，利用 dtspartition 函数计算出对应的 SplitValue</li><li>如果 ClusterBy 多列，则将这些列利用 SipHash 计算出对应的 SplitValue</li><li>计算 BucketNumber</li><li>如果是 WithRange，则用 SplitValue <!-- -->*<!-- --> BucketCount / SplitNumber 计算对应 BucketNumber</li><li>如果不是 WithRange，则用 SplitValue % BucketCount 计算对应 BucketNumber</li></ul><ol><li>读取文件时</li><li>如果每行数据大小并不大，可以通过调大 max_insert_block_size 来一次读取更大的 Block，从而生成更大的 Part</li><li>如果读取的文件不是 HDFS/CFS 的，同时使用通配符匹配了多个文件，也可以同时调大 min_insert_block_size_rows 和 min_insert_block_size_bytes</li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags__Zuh padding--none margin-left--sm"><li class="tag_G1J1"><a class="tag_lVyf tagRegular_MP1R" href="/docs/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ByConity/ByConity/tree/main/website/../docs/en/基础使用手册/导入数据.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_rssB" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ZTIL"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/参与社区/社区行为准则 Community Code of Conduct"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">社区行为准则</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/基础使用手册/导出数据"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">导出数据</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a4zv thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#按场景划分" class="table-of-contents__link toc-highlight">按场景划分</a></li><li><a href="#支持的数据格式" class="table-of-contents__link toc-highlight">支持的数据格式</a></li><li><a href="#流式导入数据本地文件及内存数据" class="table-of-contents__link toc-highlight">流式导入数据(本地文件及内存数据)</a><ul><li><a href="#方式一" class="table-of-contents__link toc-highlight">方式一：</a></li><li><a href="#方式二" class="table-of-contents__link toc-highlight">方式二：</a></li><li><a href="#方式三" class="table-of-contents__link toc-highlight">方式三：</a></li></ul></li><li><a href="#通过外部存储数据导入" class="table-of-contents__link toc-highlight">通过外部存储数据导入</a></li><li><a href="#使用-kakfa-导入数据" class="table-of-contents__link toc-highlight">使用 kakfa 导入数据</a><ul><li><a href="#功能定义" class="table-of-contents__link toc-highlight">功能定义</a></li><li><a href="#实现原理" class="table-of-contents__link toc-highlight">实现原理</a></li><li><a href="#使用指南" class="table-of-contents__link toc-highlight">使用指南</a></li><li><a href="#运维手册" class="table-of-contents__link toc-highlight">运维手册</a></li></ul></li><li><a href="#通过-spark-导入外部数据" class="table-of-contents__link toc-highlight">通过 Spark 导入外部数据</a></li><li><a href="#通过-byconity-访问外部数据源" class="table-of-contents__link toc-highlight">通过 ByConity 访问外部数据源</a><ul><li><a href="#mysql" class="table-of-contents__link toc-highlight">MySQL</a></li><li><a href="#hive" class="table-of-contents__link toc-highlight">Hive</a></li><li><a href="#使用" class="table-of-contents__link toc-highlight">使用：</a></li></ul></li><li><a href="#直接写入方式调优" class="table-of-contents__link toc-highlight">直接写入方式调优</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/ByConity简介/主要原理概念">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ByteDance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.42b9ce04.js"></script>
<script src="/assets/js/main.081140d6.js"></script>
</body>
</html>