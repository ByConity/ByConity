<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-基础使用手册/设计库表">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">设计库表 | ByConity</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://byconity.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://byconity.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://byconity.github.io/docs/基础使用手册/设计库表"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="设计库表 | ByConity"><meta data-rh="true" name="description" content="文档类型：教程型"><meta data-rh="true" property="og:description" content="文档类型：教程型"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://byconity.github.io/docs/基础使用手册/设计库表"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/基础使用手册/设计库表" hreflang="en"><link data-rh="true" rel="alternate" href="https://byconity.github.io/zh-cn/docs/基础使用手册/设计库表" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/基础使用手册/设计库表" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ByConity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ByConity Atom Feed"><link rel="stylesheet" href="/assets/css/styles.320eaf13.css">
<link rel="preload" href="/assets/js/runtime~main.42b9ce04.js" as="script">
<link rel="preload" href="/assets/js/main.081140d6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_dYNx" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--light_CjtC"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--dark_quyK"></div><b class="navbar__title text--truncate">ByConity</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/ByConity简介/主要原理概念">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_B_6h"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/docs/基础使用手册/设计库表" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/基础使用手册/设计库表" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ldyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MxCR docsWrapper_h_X8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Kzpt" type="button"></button><div class="docPage_GWs5"><aside class="theme-doc-sidebar-container docSidebarContainer_ldoy"><div class="sidebarViewport_TwFD"><div class="sidebar_H_01"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_J18w"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/ByConity简介/主要原理概念">ByConity简介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/SQL语法说明/ansi-compatibility">SQL语法说明</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/参与社区/Linux 搭建 ByConity 开发环境">参与社区</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/基础使用手册/导入数据">基础使用手册</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/导入数据">导入数据</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/导出数据">导出数据</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/数据可视化">数据可视化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/数据类型">数据类型</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/监控集群">监控集群</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/管理后台任务">管理后台任务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/基础使用手册/设计库表">设计库表</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/连接客户端">连接客户端</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/部署要求">部署要求</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/配置计算组">配置计算组</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/基础使用手册/集群配置参数">集群配置参数</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/高级用户手册/事物和并发控制">高级用户手册</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_baW4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Njrt"><div class="docItemContainer_ZzVP"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HWXL" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_IT7R"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">基础使用手册</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">设计库表</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_GIgr theme-doc-toc-mobile tocMobile_JEhh"><button type="button" class="clean-btn tocCollapsibleButton_Q9up">On this page</button></div><div class="theme-doc-markdown markdown"><h1>设计库表</h1><p>文档类型：教程型</p><p>文档格式：教程目的，前置准备，分步骤讲解原理 &amp; 示例，相关文档推荐；</p><p>内容提要：</p><ol><li>ByConity 是如何组织数据库和数据表的</li><li>数据库表的规格，比如单数据库支持放多少数据表，单表支持多少列</li><li>设计数据表时，应该理解哪些配置（primary key 等）</li><li>典型场景下，设计数据表的最佳实践是什么</li></ol><h2 class="anchor anchorWithStickyNavbar_er05" id="组织库表">组织库表<a href="#组织库表" class="hash-link" aria-label="Direct link to 组织库表" title="Direct link to 组织库表">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="数据库">数据库<a href="#数据库" class="hash-link" aria-label="Direct link to 数据库" title="Direct link to 数据库">​</a></h3><p>ByConity 的数据库是一组相关联的表或者视图的组合，方便用户管理这组 schema 的生命周期以及权限控制。ByConity 对数据库的数目上限没有硬性限制。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="数据表">数据表<a href="#数据表" class="hash-link" aria-label="Direct link to 数据表" title="Direct link to 数据表">​</a></h3><p>从逻辑上看，数据表是一组拥有相同行数的数据列的集合，并从属某个数据库。ByConity 对一个数据库的表数目也没有限制（最好不超过百万）。一个表拥有的数据列数目不超过 10 万。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="表引擎">表引擎<a href="#表引擎" class="hash-link" aria-label="Direct link to 表引擎" title="Direct link to 表引擎">​</a></h4><p>表引擎即表的类型，决定了：</p><ul><li>数据的组织和存储方式</li><li>索引的方式以及索引类型</li><li>支持哪些查询以及如何支持</li><li>一些其他特定的功能和配置</li></ul><p>ByConity 最常用的表引擎是 CnchMergeTree。其他特殊类型的表引擎包括 Hive 外表、Kafka 表等 。下面重点讲下 MergeTree 表引擎的原理。</p><h4 class="anchor anchorWithStickyNavbar_er05" id="cnchmergetree-表原理">CnchMergeTree 表原理<a href="#cnchmergetree-表原理" class="hash-link" aria-label="Direct link to CnchMergeTree 表原理" title="Direct link to CnchMergeTree 表原理">​</a></h4><p>CnchMergeTree 表是最常用的表引擎，核心思想和 LSM-Tree 类似，数据按分区键(partition by)进行分区，然后排序键(order by)进行有序存储。主要特点：</p><ul><li>如果指定了分区键的话，数据会按分区键划分成了不同的逻辑数据集（逻辑分区，Partition)</li></ul><p>每一个逻辑分区可以存在零到多个数据片段（DataPart）。如果查询条件可以裁剪分区，通常可以加速查询。如果没有指定分区键，全部数据都在一个逻辑分区里。</p><ul><li>数据片段</li></ul><p>数据片段里的数据按排序键排序。每个数据片段还会存在一个 min/max 索引，来加速分区选择。</p><ul><li>数据颗粒（Granule）</li></ul><p>每个数据片段被逻辑的分割成颗粒（granule ），默认的 Granule 为 8192 行（由表的 index_granularity 配置决定）。颗粒是 ByConity 中进行数据查询时的最小不可分割数据集。每个颗粒的第一行通过该行的主键值进行标记， ByConity 会为每个数据片段创建一个索引文件来存储这些标记。对于每列，无论它是否包含在主键当中，ByConity 都会存储类似标记。这些标记让您可以在列文件中直接找到数据。Granule 作为 ByConity 稀疏索引的索引目标，也是在内存中进行数据扫描的单位。</p><ul><li>后台 Merge</li></ul><p>后台任务会定时对同一个分区的 DataPart 进行合并，并保持按排序键有序。后台的合并减少了 Part 的数目，以便更高效存储，并提升了查询性能。</p><h2 class="anchor anchorWithStickyNavbar_er05" id="cnchmergetree-建表语句和相关配置">CnchMergeTree 建表语句和相关配置<a href="#cnchmergetree-建表语句和相关配置" class="hash-link" aria-label="Direct link to CnchMergeTree 建表语句和相关配置" title="Direct link to CnchMergeTree 建表语句和相关配置">​</a></h2><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">CREATE TABLE [IF NOT EXISTS] [db.]table_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name1 [type1] [NULL|NOT NULL] [DEFAULT|ALIAS expr1] [compression_codec] [TTL expr1],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name2 [type2] [NULL|NOT NULL] [DEFAULT|ALIAS expr2] [compression_codec] [TTL expr2],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) ENGINE = CnchMergeTree()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ORDER BY expr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[PARTITION BY expr]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[CLUSTER BY (column, expression, ...) INTO value1 BUCKETS SPLIT_NUMBER value2 WITH_RANGE]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[PRIMARY KEY expr]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[UNIQUE KEY expr]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[SAMPLE BY expr]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[TTL expr]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[SETTINGS name=value, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_er05" id="设计分区键partition-by">设计分区键（PARTITION BY)<a href="#设计分区键partition-by" class="hash-link" aria-label="Direct link to 设计分区键（PARTITION BY)" title="Direct link to 设计分区键（PARTITION BY)">​</a></h3><p>分区键定义分区，分区是在一个表中通过指定的规则划分而成的逻辑数据集。可以按任意标准进行分区，如按日期。为了减少需要操作的数据，每个分区都是分开存储的。查询时，ByConity 尽量使用这些分区的最小子集。建表时候通过 <code>PARTITION BY expr</code> 子句指定。分区键可以是表中列的任意表达式。例如，指定按月分区，表达式为 <code>toYYYYMM(date)</code>；或者按表达元组，如 <code>(toMonday(date), EventType)</code> 等。</p><p>需要注意，表中分区表达式计算出的取值范围不能太大（推荐不超过一万），太多分区会占用比较大的内存以及带来比较多的 IO 和计算开销。</p><p>合理的设计分区键可以极大减少查询时需要扫描的数据量，一般考虑将查询中最常用的条件同时取值范围不超过一万的列设计为分区键（如日期等）。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="设计排序键order-by">设计排序键（ORDER BY）<a href="#设计排序键order-by" class="hash-link" aria-label="Direct link to 设计排序键（ORDER BY）" title="Direct link to 设计排序键（ORDER BY）">​</a></h3><p>可以是一组列的元组或任意的表达式。 例如: <code>ORDER BY (OrderID, Date)</code> 。</p><p>如果不需要排序，可以使用 <code>ORDER BY tuple()</code>。DataPart 里的数据将按照排序键进行排序。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="设计主键primary-key">设计主键(PRIMARY KEY)<a href="#设计主键primary-key" class="hash-link" aria-label="Direct link to 设计主键(PRIMARY KEY)" title="Direct link to 设计主键(PRIMARY KEY)">​</a></h3><p>默认情况不需要显式指定，ByConity 将使用排序键作为主键。当有特殊场景主键和排序键不一致时，主键必须为排序键的最左前缀。如排序键为(OrderID, Date)，主键必须为 OrderID，不能为 Date。在一些特殊的表引擎，如 CnchAggregatingMergeTree、CnchSumMergeTree 中，主键会与排序键不同。</p><p>ByConity 会在主键上建立以 Granule 为单位的稀疏索引，（与之对比，所谓稠密索引则是每一行都会建立索引信息）。</p><p>如果查询条件能匹配主键索引的最左前缀，通过主键索引可以快速过滤出可能需要读取的数据颗粒，相比扫描整个 DataPart，通常要高效很多。</p><p>另外需要注意，PRIMARY KEY 不能保证唯一性，所以可以插入主键重复的数据行。</p><p>分区（PARTITION BY）和主键(PRIMARY KEY)是两种不同的加速数据查询的方式，定义的时候应当尽量错开使用不同的列来定义两者，来覆盖更多的查询场景。例如 order by 的第一个列一定不要重复放到 partition by 里。下面是如何选择主键的一些考虑：</p><ul><li>是否是查询条件里常用的列</li><li>不是非分区键的第一个列</li><li>这个列的选择性，例如性别、是/否这种可选值太少的列不建议放入主键中</li><li>假如现在的主键是（a，b)，如果在大多数情况下给定（a，b）对应的数据范围很大（包含多个 Granule），可以考虑把一个新的查询常用列附加到主键中，这样可以过滤更多的数据。</li><li>过长的主键会对插入性能和内存消耗有负面影响，但对查询性能没有影响。</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="唯一键索引unique-key">唯一键索引(UNIQUE KEY)<a href="#唯一键索引unique-key" class="hash-link" aria-label="Direct link to 唯一键索引(UNIQUE KEY)" title="Direct link to 唯一键索引(UNIQUE KEY)">​</a></h3><p>主键（PRIMARY KEY）不能保证去重，如果有唯一键去重的需求，需要在建表时设置唯一键索引。设置唯一键之后，ByConity 提供 upsert 更新写语义，可以根据唯一键高效更新数据行。查询自动返回每个唯一键的最新值。</p><p>唯一键可以是一组列的元组或任意的表达式，如 <code>UNIQUE KEY (product_id, sipHash64(city))</code>。</p><p>唯一建索引可以通过配置 <code>partition_level_unique_keys</code> 控制是分区级别唯一还是全表唯一，目前推荐实践为：分区唯一索引，单分区数据量不超过千万级别<strong>。</strong>若为全表唯一，则全表数据量建议不超过千万级别。</p><p>通过唯一键查询时会用上唯一键索引过滤数据加速查询，所以通常主键可以设置和唯一键不一样列，覆盖更多的查询条件。不过如果要使用部分列更新功能的话，是需要唯一键为排序键的最左前缀。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="跳数索引index">跳数索引（Index）<a href="#跳数索引index" class="hash-link" aria-label="Direct link to 跳数索引（Index）" title="Direct link to 跳数索引（Index）">​</a></h3><p>建表时可以这样定义跳数索引</p><div class="codeBlockContainer_sAXX theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_pc2u"><pre tabindex="0" class="prism-code language-text codeBlock_fjSB thin-scrollbar"><code class="codeBlockLines_FFvy"><span class="token-line" style="color:#393A34"><span class="token plain">INDEX index_name expr TYPE type(...) GRANULARITY granularity_value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_tcEP"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_Zxeh" aria-hidden="true"><svg class="copyButtonIcon_Pc49" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_Ol7y" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_er05" id="可用的索引类型">可用的索引类型<a href="#可用的索引类型" class="hash-link" aria-label="Direct link to 可用的索引类型" title="Direct link to 可用的索引类型">​</a></h4><ul><li><code>minmax</code> 存储指定表达式的极值（如果表达式是 <code>tuple</code> ，则存储 <code>tuple</code> 中每个元素的极值），这些信息用于跳过数据块，类似主键。</li></ul><p>跳数索引功能正在测试中，等完成后补充支持的跳数索引类型。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="设计-bucket">设计 Bucket<a href="#设计-bucket" class="hash-link" aria-label="Direct link to 设计 Bucket" title="Direct link to 设计 Bucket">​</a></h3><p>CNCH Bucket table 最佳实践手册</p><h3 class="anchor anchorWithStickyNavbar_er05" id="采样">采样<a href="#采样" class="hash-link" aria-label="Direct link to 采样" title="Direct link to 采样">​</a></h3><p>用于抽样的表达式，可选项。</p><p>如果要用抽样表达式，主键中必须包含这个表达式。例如： <code>SAMPLE BY intHash32(UserID) ORDER BY (CounterID, EventDate, intHash32(UserID))</code> 。</p><p>细节参考采样功能（需要独立一篇采样功能）</p><h3 class="anchor anchorWithStickyNavbar_er05" id="列和表的-ttl">列和表的 TTL<a href="#列和表的-ttl" class="hash-link" aria-label="Direct link to 列和表的 TTL" title="Direct link to 列和表的 TTL">​</a></h3><p>指定行存储的持续时间并定义数据片段在硬盘和卷上的移动逻辑的规则列表，可选项。</p><p>表达式中必须存在至少一个 <code>Date</code> 或 <code>DateTime</code> 类型的列，比如：</p><p><code>TTL date + INTERVAl 1 DAY</code></p><p>更多细节，请查看 <a href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-ttl" target="_blank" rel="noopener noreferrer">表和列的 TTL</a>（太多了，可能要独立一篇 TTL 的）</p><h3 class="anchor anchorWithStickyNavbar_er05" id="高级配置">高级配置<a href="#高级配置" class="hash-link" aria-label="Direct link to 高级配置" title="Direct link to 高级配置">​</a></h3><h4 class="anchor anchorWithStickyNavbar_er05" id="granule-配置">Granule 配置<a href="#granule-配置" class="hash-link" aria-label="Direct link to Granule 配置" title="Direct link to Granule 配置">​</a></h4><ul><li><code>index_granularity</code> — 索引粒度。索引中相邻的『标记』间的数据行数（对应 Granule 大小）。默认值 8192 。</li></ul><p>后面三个配置待测试，RD 未验证功能。</p><ul><li><code>index_granularity_bytes</code> — 索引粒度，以字节为单位，默认值: 10Mb。如果想要仅按数据行数限制索引粒度, 请设置为 0(不建议)。</li><li><code>min_index_granularity_bytes</code> - 允许的最小数据粒度，默认值：1024b。该选项用于防止误操作，添加了一个非常低索引粒度的表。</li><li><code>enable_mixed_granularity_parts</code> — 是否启用通过 <code>index_granularity_bytes</code> 控制索引粒度的大小。在老版本只有 <code>index_granularity</code> 配置能够用于限制索引粒度的大小。当从具有很大的行（几十上百兆字节）的表中查询数据时候，<code>index_granularity_bytes</code> 配置能够提升 ByConity 的性能。如果您的表里有很大的行，可以开启这项配置来提升 <code>SELECT</code> 查询的性能。</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="计算组配置">计算组配置<a href="#计算组配置" class="hash-link" aria-label="Direct link to 计算组配置" title="Direct link to 计算组配置">​</a></h4><p>参考 【教程型】配置计算组</p><h4 class="anchor anchorWithStickyNavbar_er05" id="merge-相关配置">merge 相关配置<a href="#merge-相关配置" class="hash-link" aria-label="Direct link to merge 相关配置" title="Direct link to merge 相关配置">​</a></h4><p>参考后台任务章节</p><h4 class="anchor anchorWithStickyNavbar_er05" id="存储相关配置">存储相关配置<a href="#存储相关配置" class="hash-link" aria-label="Direct link to 存储相关配置" title="Direct link to 存储相关配置">​</a></h4><p>参考存储相关章节</p><h4 class="anchor anchorWithStickyNavbar_er05" id="唯一索引相关配置">唯一索引相关配置<a href="#唯一索引相关配置" class="hash-link" aria-label="Direct link to 唯一索引相关配置" title="Direct link to 唯一索引相关配置">​</a></h4><ul><li><code>partition_level_unique_keys</code> - 唯一索引是否是分区唯一，默认值：<code>true</code>；如果为 <code>false</code>，代表唯一索引是全表级别；</li><li><code>cloud_enable_staging_area</code> - 是否开启异步写入模式，默认值：<code>false</code>。</li></ul><h4 class="anchor anchorWithStickyNavbar_er05" id="其他配置">其他配置<a href="#其他配置" class="hash-link" aria-label="Direct link to 其他配置" title="Direct link to 其他配置">​</a></h4><h2 class="anchor anchorWithStickyNavbar_er05" id="最佳实践">最佳实践<a href="#最佳实践" class="hash-link" aria-label="Direct link to 最佳实践" title="Direct link to 最佳实践">​</a></h2><h3 class="anchor anchorWithStickyNavbar_er05" id="主键索引的最佳实践">主键索引的最佳实践<a href="#主键索引的最佳实践" class="hash-link" aria-label="Direct link to 主键索引的最佳实践" title="Direct link to 主键索引的最佳实践">​</a></h3><p><a href="https://clickhouse.com/docs/zh/guides/improving-query-performance/sparse-primary-indexes/" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/zh/guides/improving-query-performance/sparse-primary-indexes/</a></p><h3 class="anchor anchorWithStickyNavbar_er05" id="二级索引最佳实践">二级索引最佳实践<a href="#二级索引最佳实践" class="hash-link" aria-label="Direct link to 二级索引最佳实践" title="Direct link to 二级索引最佳实践">​</a></h3><p><a href="https://clickhouse.com/docs/zh/guides/improving-query-performance/skipping-indexes" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/zh/guides/improving-query-performance/skipping-indexes</a></p><h3></h3><h3 class="anchor anchorWithStickyNavbar_er05" id="列类型考虑">列类型考虑<a href="#列类型考虑" class="hash-link" aria-label="Direct link to 列类型考虑" title="Direct link to 列类型考虑">​</a></h3><h3 class="anchor anchorWithStickyNavbar_er05" id="避免一味使用-string-类型">避免一味使用 String 类型<a href="#避免一味使用-string-类型" class="hash-link" aria-label="Direct link to 避免一味使用 String 类型" title="Direct link to 避免一味使用 String 类型">​</a></h3><p>如果可能的情况下使用 Int(8|16|32|64|128|256) / Date / Date32 / DateTime / DateTime64 / Float / Decimal 代替 String</p><p>最简单的判断方法就是看是否可以转换到目标类型比如 <code>SELECT countIf(toUInt8OrNull(col) IS NULL) FROM table</code>, <code>SELECT countIf(toDateOrNull(col) IS NULL) FROM table</code></p><p>对内容相对固定的 String Column, 可以考虑使用 Enum 代替，比如省份名称. Enum 后期可以通过 <code>ALTER TABLE</code> 添加新值</p><p>String 最小最大长度差距不超过 8 的情况下使用 FixedString，因为 String 相比 FixedString 在内存中要多储存 8 字节的 offset <code>SELECT min(length(col)), max(length(col)) FROM table</code></p><h3 class="anchor anchorWithStickyNavbar_er05" id="nullable-选择">Nullable 选择<a href="#nullable-选择" class="hash-link" aria-label="Direct link to Nullable 选择" title="Direct link to Nullable 选择">​</a></h3><p>如果确定列中不包含 Null，不要使用 Nullable 类型，会对性能有负面影响</p><h3 class="anchor anchorWithStickyNavbar_er05" id="lowcardinality">LowCardinality<a href="#lowcardinality" class="hash-link" aria-label="Direct link to LowCardinality" title="Direct link to LowCardinality">​</a></h3><p>如果某个列的基数较低，例如一个 DataPart 内只有不超过 10000 个不相等的值，可以考虑用 LowCardinality 类型。LowCardinality 类型会对原始列进行字典编码。对很多应用来说，处理字典编码的数据可以显著的增加查询速度，并且降低存储空间，提升 IO 效率。</p><h3 class="anchor anchorWithStickyNavbar_er05" id="列-codec-选择">列 Codec 选择<a href="#列-codec-选择" class="hash-link" aria-label="Direct link to 列 Codec 选择" title="Direct link to 列 Codec 选择">​</a></h3><p>通用编码 lz4 / lz4hc / zstd / deflate_qpl</p><p><a href="https://clickhouse.com/docs/en/sql-reference/statements/create/table/#general-purpose-codecs" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/sql-reference/statements/create/table/#general-purpose-codecs</a></p><p>通常来说 lz4 编码快但压缩率没有 zstd 高, 在支持 Intel IAA 的平台上可以考虑使用 qpl</p><p>特殊编码可以和上面的通用编码一起使用: Delta / DoubleDelta / Gorilla / FPC / T64</p><p><a href="https://clickhouse.com/docs/en/sql-reference/statements/create/table/#specialized-codecs" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/sql-reference/statements/create/table/#specialized-codecs</a></p><p>一般来说时序可以用 doubledelta, 随时序变化的值可以用 gorilla, FPC 在 64bit 浮点数上效果比较好. T64 是寻找 64 个值的共同高位进行裁剪，只记录变化的部分</p><p>下面是一些最佳实践</p><ul><li>DateTime 类型: 未排序，建议用 Delta+LZ4</li><li>DateTime 类型：排序，建议用 LZ4</li><li>Date 类型：未排序，建议用 ZSTD</li><li>Date 类型：排序（例：PK），建议用 LZ4</li></ul><h3 class="anchor anchorWithStickyNavbar_er05" id="参考文档">参考文档<a href="#参考文档" class="hash-link" aria-label="Direct link to 参考文档" title="Direct link to 参考文档">​</a></h3><p><a href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de</a></p><p><a href="https://clickhouse.com/docs/en/sql-reference/statements/create/table/#column-compression-codecs" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/sql-reference/statements/create/table/#column-compression-codecs</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags__Zuh padding--none margin-left--sm"><li class="tag_G1J1"><a class="tag_lVyf tagRegular_MP1R" href="/docs/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ByConity/ByConity/tree/main/website/../docs/en/基础使用手册/设计库表.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_rssB" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ZTIL"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/基础使用手册/管理后台任务"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">管理后台任务</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/基础使用手册/连接客户端"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">连接客户端</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a4zv thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#组织库表" class="table-of-contents__link toc-highlight">组织库表</a><ul><li><a href="#数据库" class="table-of-contents__link toc-highlight">数据库</a></li><li><a href="#数据表" class="table-of-contents__link toc-highlight">数据表</a></li></ul></li><li><a href="#cnchmergetree-建表语句和相关配置" class="table-of-contents__link toc-highlight">CnchMergeTree 建表语句和相关配置</a><ul><li><a href="#设计分区键partition-by" class="table-of-contents__link toc-highlight">设计分区键（PARTITION BY)</a></li><li><a href="#设计排序键order-by" class="table-of-contents__link toc-highlight">设计排序键（ORDER BY）</a></li><li><a href="#设计主键primary-key" class="table-of-contents__link toc-highlight">设计主键(PRIMARY KEY)</a></li><li><a href="#唯一键索引unique-key" class="table-of-contents__link toc-highlight">唯一键索引(UNIQUE KEY)</a></li><li><a href="#跳数索引index" class="table-of-contents__link toc-highlight">跳数索引（Index）</a></li><li><a href="#设计-bucket" class="table-of-contents__link toc-highlight">设计 Bucket</a></li><li><a href="#采样" class="table-of-contents__link toc-highlight">采样</a></li><li><a href="#列和表的-ttl" class="table-of-contents__link toc-highlight">列和表的 TTL</a></li><li><a href="#高级配置" class="table-of-contents__link toc-highlight">高级配置</a></li></ul></li><li><a href="#最佳实践" class="table-of-contents__link toc-highlight">最佳实践</a><ul><li><a href="#主键索引的最佳实践" class="table-of-contents__link toc-highlight">主键索引的最佳实践</a></li><li><a href="#二级索引最佳实践" class="table-of-contents__link toc-highlight">二级索引最佳实践</a></li><li><a href="#列类型考虑" class="table-of-contents__link toc-highlight">列类型考虑</a></li><li><a href="#避免一味使用-string-类型" class="table-of-contents__link toc-highlight">避免一味使用 String 类型</a></li><li><a href="#nullable-选择" class="table-of-contents__link toc-highlight">Nullable 选择</a></li><li><a href="#lowcardinality" class="table-of-contents__link toc-highlight">LowCardinality</a></li><li><a href="#列-codec-选择" class="table-of-contents__link toc-highlight">列 Codec 选择</a></li><li><a href="#参考文档" class="table-of-contents__link toc-highlight">参考文档</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/ByConity简介/主要原理概念">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ByteDance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.42b9ce04.js"></script>
<script src="/assets/js/main.081140d6.js"></script>
</body>
</html>