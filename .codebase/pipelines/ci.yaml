name: CI
trigger:
  change:
  manual:
    types: ["create", "push", "submit"]
jobs:
  scm_build:
    name: Build binary (for clang11 ch_vanilla_debian_ci)
    image: hub.byted.org/data-ci-debian:latest
    runs-on:
      spec: m1.4xlarge
      env: online
    steps:
      - uses: actions/checkout
        inputs:
          depth: 1
      - uses: actions/scm
        id: scm_build
        inputs:
          scm_repo: dp/clickhouse/ch_vanilla_clang_ci
          version_type: test
          sync_bvc: false
          sync_aws: false
          sync_oss: false
          envs: {CUSTOM_CMAKE_BUILD_TYPE: "Release"}

  CeFuntionalStatelessTest: &default_test
    name: CE - FuntionalStatelessTest
    image: hub.byted.org/bytehouse/clickhouse-stateless-test:gdb12.1v1
    depends: [scm_build]
    envs:
      CONSUL_HTTP_HOST: "10.8.156.215"
      CONSUL_HTTP_PORT: "2280"
      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go"
    runs-on:
      spec: m1.4xlarge
      env: online
    steps:
      - &action_checkout
        uses: actions/checkout
        inputs:
          depth: 1
      - &download_scm_binary
        name: Download From SCM
        commands:
          - echo $(pwd)
          - cd /
          - CLICKHOUSE_VERSION=${{ Jobs["scm_build"].Steps["scm_build"].Outputs["version"] }}
          - CLICKHOUSE_PREFIX="clickhouse"
          - mkdir -p $CLICKHOUSE_PREFIX
          - wget -q -O $CLICKHOUSE_PREFIX/clickhouse.tar.gz http://d.scm.byted.org/api/v2/download/ceph:dp.clickhouse.ch_vanilla_clang_ci_$CLICKHOUSE_VERSION.tar.gz
          - tar zxf $CLICKHOUSE_PREFIX/clickhouse.tar.gz  --directory clickhouse
          - rm $CLICKHOUSE_PREFIX/clickhouse.tar.gz
      - name: Run FuntionalStatelessTest
        commands:
          - cd /
          - export ADDITIONAL_OPTIONS='--jobs 1 --run ce_stateless'
          - cp -r /home/code/docker/test/stateless/. .
          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
          - /bin/bash run.sh
      - &after_test
        name: after test
        commands:
          - bash /home/code/.codebase/ci_scripts/common_component/copy_core_to_shared.sh # copy core to artifact folder
          - bash /home/code/.codebase/ci_scripts/common_component/copy_case_stdout_to_shared.sh # copy stdout to artifact folder
      - &upload_artifact
        name: Upload Artifact
        uses: actions/upload-artifact
        inputs:
          name: Artifacts
          path: /test_output
      - &analyse_result
        name: Analyse Result
        commands:
          - /bin/bash /home/code/docker/test/result.sh

  CeProblematicFuntionalStatelessTest:
    <<: *default_test
    name: CE - problematic - FuntionalStatelessTest
    steps:
      - *action_checkout
      - *download_scm_binary
      - name: Run FuntionalStatelessTest
        commands:
          - cd /
          - cp -r /home/code/docker/test/stateless/. .
          - export ADDITIONAL_OPTIONS='--jobs 1 --run ce_problematic_stateless'   # enable optimizer for test
          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
          - /bin/bash run.sh
      - *after_test
      - *upload_artifact
      - name: Analyse Result
        commands:
          - /bin/bash /home/code/docker/test/result.sh
        ignore-error: true

  CnchFuntionalStatelessTest:
    <<: *default_test
    name: CNCH - FuntionalStatelessTest
    envs:
      CONSUL_HTTP_HOST: "10.8.156.215"
      CONSUL_HTTP_PORT: "2280"
      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go:/clickhouse/usr/breakpad/bin:/clickhouse/bin"
    steps:
      - *action_checkout
      - *download_scm_binary
      - name: Run Cnch FuntionalStatelessTest
        commands:
          - bash /home/code/.codebase/ci_scripts/cnch_config/1_single_server/run.sh
          - python3 /home/code/tests/clickhouse-test --run cnch_stateless -q  /home/code/tests/queries --order asc
        continue-on-error: true
      - *after_test
      - name: Upload Artifact
        uses: actions/upload-artifact
        inputs:
          name: Artifacts
          path: /artifacts

  CnchFuntionalStatelessTestProblematic:
    <<: *default_test
    name: CNCH - Problematic - FuntionalStatelessTest
    envs:
      CONSUL_HTTP_HOST: "10.8.156.215"
      CONSUL_HTTP_PORT: "2280"
      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go:/clickhouse/usr/breakpad/bin:/clickhouse/bin"
    steps:
      - *action_checkout
      - *download_scm_binary
      - name: Run Cnch FuntionalStatelessTest
        commands:
          - bash /home/code/.codebase/ci_scripts/cnch_config/1_single_server/run.sh
          - python3 /home/code/tests/clickhouse-test --run cnch_problematic_stateles -q  /home/code/tests/queries --order asc
        ignore-error: true
      - *after_test
      - name: Upload Artifact
        uses: actions/upload-artifact
        inputs:
          name: Artifacts
          path: /artifacts

#  FuntionalStatelessTestWithOptimizer:
#    <<: *default_test
#    name: FuntionalStatelessTestWithOptimizer
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run FuntionalStatelessTest
#        commands:
#          - cd /
#          - cp -r /home/code/docker/test/stateless/. .
#          - export ADDITIONAL_OPTIONS='--client-option enable_optimizer=1 --jobs 1'   # enable optimizer for test
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *analyse_result
#
#  FuntionalStatefulTest:
#    <<: *default_test
#    name: FuntionalStatefulTest
#    image: hub.byted.org/bytehouse/clickhouse-stateful-test:gdb12.1v1
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run FuntionalStatefulTest
#        commands:
#          - export ADDITIONAL_OPTIONS='--jobs 1'
#          - cd /
#          - cp -r /home/code/docker/test/stateful/. .
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *analyse_result
#
#  FuntionalStatefulTestWithOptimizer:
#    <<: *default_test
#    name: FuntionalStatefulTestWithOptimizer
#    image: hub.byted.org/bytehouse/clickhouse-stateful-test:gdb12.1v1
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run FuntionalStatefulTest with Optimizer
#        commands:
#          - export ADDITIONAL_OPTIONS='--jobs 1'
#          - cd /
#          - cp -r /home/code/docker/test/stateful/. .
#          - export ADDITIONAL_OPTIONS='--client-option enable_optimizer=1'   # enable optimizer for test
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *analyse_result
#
#  CertificateStatefullTest:
#    <<: *default_test
#    name: CertificateStatefullTest
#    image: hub.byted.org/bytehouse/clickhouse-stateful-test:gdb12.1v1
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run CertificateStatefullTest
#        commands:
#          - cd /
#          - cp /home/code/docker/test/certificate/run.sh run.sh
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *analyse_result
#
#  CertificateStatefullTestWithOptimizer:
#    <<: *default_test
#    name: CertificateStatefullTestWithOptimizer
#    image: hub.byted.org/bytehouse/clickhouse-stateful-test:gdb12.1v1
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run CertificateStatefullTest
#        commands:
#          - cd /
#          - cp /home/code/docker/test/certificate/run.sh run.sh
#          - export ADDITIONAL_OPTIONS='--client-option enable_optimizer=1'   # enable optimizer for test
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *analyse_result
#
#  StressTest:
#    <<: *default_test
#    name: StressTest
#    image: hub.byted.org/bytehouse/clickhouse-stress-test:gdb12.1v1
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run FuntionalStressTest
#        commands:
#          - cd /
#          - cp /home/code/docker/test/stress/run.sh run.sh
#          - cp /home/code/docker/test/stress/stress stress
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *analyse_result
#
#  scm_build_ASAN: #Build will be skipped by default
#    name: Build ASAN enabled binary (for clang11 ch_vanilla_debian_ci)
#    image: hub.byted.org/data-ci-debian:latest
#    runs-on:
#      spec: m1.8xlarge
#      env: online
#    if: ${{ false }}
#    steps:
#      - uses: actions/checkout
#        inputs:
#          depth: 1
#      - uses: actions/scm
#        id: scm_build
#        inputs:
#          scm_repo: dp/clickhouse/ch_vanilla_clang_ci
#          version_type: test
#          sync_bvc: false
#          sync_aws: false
#          sync_oss: false
#          envs:
#            CUSTOM_CMAKE_BUILD_TYPE: "Debug"
#            CUSTOM_SANITIZE: "address"
#
#  FuntionalStatelessTest-ASAN: &default_test_asan #Test will be skipped by default if SCM ASAN build is skipped
#    name: FuntionalStatelessTest-ASAN
#    image: hub.byted.org/bytehouse/clickhouse-stateless-test:gdb12.1v1
#    depends: [scm_build_ASAN]
#    runs-on:
#      spec: m1.8xlarge
#      env: online
#    if: ${{ Jobs.scm_build_ASAN.Conclusion == "success" }}
#    envs:
#      ASAN_OPTIONS: "halt_on_error=false,log_path=/var/log/clickhouse-server/asan.log"
#      CONSUL_HTTP_HOST: "10.8.156.215"
#      CONSUL_HTTP_PORT: "2280"
#      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go:/clickhouse/usr/breakpad/bin"
#    steps:
#      - &action_checkout_asan
#        name: Download From SCM
#        commands:
#          - echo $(pwd)
#          - cd /
#          - CLICKHOUSE_VERSION=${{ Jobs["scm_build_ASAN"].Steps["scm_build"].Outputs["version"] }}
#          - CLICKHOUSE_PREFIX="clickhouse"
#          - mkdir -p $CLICKHOUSE_PREFIX
#          - wget -q -O $CLICKHOUSE_PREFIX/clickhouse.tar.gz http://d.scm.byted.org/api/v2/download/ceph:dp.clickhouse.ch_vanilla_clang_ci_$CLICKHOUSE_VERSION.tar.gz
#          - tar zxf $CLICKHOUSE_PREFIX/clickhouse.tar.gz  --directory clickhouse
#          - rm $CLICKHOUSE_PREFIX/clickhouse.tar.gz
#      - name: Run FuntionalStatelessTest
#        commands:
#          - cd /
#          - cp -r /home/code/docker/test/stateless/. .
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - &upload_sanitizer_log
#        name: Upload sanitizer log
#        uses: actions/upload-artifact
#        inputs:
#          name: sanitizer_log_output
#          path: /sanitizer_log_output
#      - *analyse_result
#
#  FuntionalStatefulTest-ASAN: #Test will be skipped by default if SCM ASAN build is skipped
#    <<: *default_test_asan
#    name: FuntionalStatefulTest-ASAN
#    image: hub.byted.org/bytehouse/clickhouse-stateful-test:gdb12.1v1
#    steps:
#      - *action_checkout_asan
#      - name: Run FuntionalStatefulTest
#        commands:
#          - cp /home/code/docker/test/stateful/run.sh run.sh
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
#
#  FuntionalStatelessTest-ASAN-LocateASANError:
#    <<: *default_test_asan
#    name: FuntionalStatelessTest-ASAN-LocateASANError
#    timeout: 360
#    steps:
#      - *action_checkout_asan
#      - name: Run  FuntionalStatelessTest-ASAN-LocateASANError
#        commands:
#          - cd /
#          - cp -r /home/code/docker/test/stateless/. .
#          - export ADDITIONAL_OPTIONS='--jobs 1 --locate-asan-error-to-case'
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
#
#  FuntionalStatelessTestWithOptimizer-ASAN-LocateASANError:
#    <<: *default_test_asan
#    name: FuntionalStatelessTestWithOptimizer-ASAN-LocateASANError
#    timeout: 360
#    steps:
#      - *action_checkout_asan
#      - name: Run  FuntionalStatelessTest-ASAN-LocateASANError
#        commands:
#          - cd /
#          - cp -r /home/code/docker/test/stateless/. .
#          - export ADDITIONAL_OPTIONS='--jobs=1 --locate-asan-error-to-case --client-option enable_optimizer=1'   # enable optimizer for test
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
#
#  IntegrationTestsRelease0:
#    name: IntegrationTestRelease0
#    image: minikube:1.22.0
#    timeout: 360
#    envs:
#      CONSUL_HTTP_HOST: "10.8.156.215"
#      CONSUL_HTTP_PORT: "2280"
#      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go:/clickhouse/usr/breakpad/bin"
#    runs-on:
#      linux: {}
###    depends: [scm_build]
#    if: ${{ false }}
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run IntegrationTest-CI-Runner
#        continue-on-error: true
#        commands:
#          - minikube start
#          - export RUN_BY_HASH_NUM=0
#          - export RUN_BY_HASH_TOTAL=2
#          - /bin/bash /home/code/tests/integration/run.sh
#      - *upload_artifact
#      - *analyse_result
#
#  IntegrationTestsRelease1:
#    name: IntegrationTestRelease1
#    image: minikube:1.22.0
#    timeout: 360
#    envs:
#      CONSUL_HTTP_HOST: "10.8.156.215"
#      CONSUL_HTTP_PORT: "2280"
#      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go:/clickhouse/usr/breakpad/bin"
#    runs-on:
#      linux: {}
###    depends: [scm_build]
#    if: ${{ false }}
#    steps:
#      - *action_checkout
#      - *download_scm_binary
#      - name: Run IntegrationTest-CI-Runner
#        continue-on-error: true
#        commands:
#          - minikube start
#          - export RUN_BY_HASH_NUM=1
#          - export RUN_BY_HASH_TOTAL=2
#          - /bin/bash /home/code/tests/integration/run.sh
#      - *upload_artifact
#      - *analyse_result
#
#  scm_build_TSAN:
#    name: Build TSAN enabled binary (for clang11 ch_vanilla_debian_ci)
#    image: hub.byted.org/data-ci-debian:latest
#    runs-on:
#      spec: m1.8xlarge
#      env: online
#    if: ${{ false }}
#    steps:
#      - *action_checkout
#      - uses: actions/scm
#        id: scm_build
#        inputs:
#          scm_repo: dp/clickhouse/ch_vanilla_clang_ci
#          version_type: test
#          sync_bvc: false
#          sync_aws: false
#          sync_oss: false
#          envs:
#            CUSTOM_CMAKE_BUILD_TYPE: "Debug"
#            CUSTOM_SANITIZE: "thread"
#
#  FuntionalStatelessTest-TSAN0: &default_test_tsan  #TSAN test runs longer time than 2hrs, hence splitted the test to TSAN0,TSAN1,TSAN2. Each test will run approximately 1000+ cases using RUN_BY_HASH_NUM and RUN_BY_HASH_TOTAL definition.
#    name: FuntionalStatelessTest-TSAN0
#    image: hub.byted.org/bytehouse/clickhouse-stateless-test:stable
#    depends: [scm_build_TSAN]
#    timeout: 360
#    if: ${{ Jobs.scm_build_TSAN.Conclusion == "success" }}
#    runs-on:
#      spec: m1.8xlarge
#      env: online
#    envs:
#      TSAN_OPTIONS: "halt_on_error=false,log_path=/var/log/clickhouse-server/tsan.log"
#      CONSUL_HTTP_HOST: "10.8.156.215"
#      CONSUL_HTTP_PORT: "2280"
#      PATH: "$PATH:/opt/tiger/yarn_deploy/hadoop/bin:/opt/tiger/consul_deploy/bin/go:/clickhouse/usr/breakpad/bin"
#    steps:
#      - *action_checkout
#      - &download_scm_binary_tsan
#        name: Download From SCM
#        commands:
#          - echo $(pwd)
#          - cd /
#          - CLICKHOUSE_VERSION=${{ Jobs["scm_build_TSAN"].Steps["scm_build"].Outputs["version"] }}
#          - CLICKHOUSE_PREFIX="clickhouse"
#          - mkdir -p $CLICKHOUSE_PREFIX
#          - wget -q -O $CLICKHOUSE_PREFIX/clickhouse.tar.gz http://d.scm.byted.org/api/v2/download/ceph:dp.clickhouse.ch_vanilla_clang_ci_$CLICKHOUSE_VERSION.tar.gz
#          - tar zxf $CLICKHOUSE_PREFIX/clickhouse.tar.gz  --directory clickhouse
#          - rm $CLICKHOUSE_PREFIX/clickhouse.tar.gz
#      - name: Run FuntionalStatelessTest
#        continue-on-error: true
#        commands:
#          - export sanitizer_type=tsan #Used to control ASAN/TSAN logs
#          - export CLICKHOUSE_WATCHDOG_ENABLE=0
#          - export RUN_BY_HASH_NUM=0
#          - export RUN_BY_HASH_TOTAL=3
#          - cd /
#          - cp /home/code/docker/test/stateless/run.sh run.sh
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
#
#  FuntionalStatelessTest-TSAN1: #TSAN test runs longer time than 2hrs, hence splitted the test to TSAN0,TSAN1,TSAN2. Each test will run approximately 1000+ cases using RUN_BY_HASH_NUM and RUN_BY_HASH_TOTAL definition.
#    <<: *default_test_tsan
#    name: FuntionalStatelessTest-TSAN1
#    image: hub.byted.org/bytehouse/clickhouse-stateless-test:stable
#    steps:
#      - *action_checkout
#      - *download_scm_binary_tsan
#      - name: Run FuntionalStatelessTest
#        continue-on-error: true
#        commands:
#          - export sanitizer_type=tsan #Used to control ASAN/TSAN logs
#          - export CLICKHOUSE_WATCHDOG_ENABLE=0
#          - export RUN_BY_HASH_NUM=1
#          - export RUN_BY_HASH_TOTAL=3
#          - cd /
#          - cp /home/code/docker/test/stateless/run.sh run.sh
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
#
#  FuntionalStatelessTest-TSAN2: #TSAN test runs longer time than 2hrs, hence splitted the test to TSAN0,TSAN1,TSAN2. Each test will run approximately 1000+ cases using RUN_BY_HASH_NUM and RUN_BY_HASH_TOTAL definition.
#    <<: *default_test_tsan
#    name: FuntionalStatelessTest-TSAN2
#    image: hub.byted.org/bytehouse/clickhouse-stateless-test:stable
#    steps:
#      - *action_checkout
#      - *download_scm_binary_tsan
#      - name: Run FuntionalStatelessTest
#        continue-on-error: true
#        commands:
#          - export sanitizer_type=tsan #Used to control ASAN/TSAN logs
#          - export CLICKHOUSE_WATCHDOG_ENABLE=0
#          - export RUN_BY_HASH_NUM=2
#          - export RUN_BY_HASH_TOTAL=3
#          - cd /
#          - cp /home/code/docker/test/stateless/run.sh run.sh
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
#
#  FuntionalStatefulTest-TSAN:
#    <<: *default_test_tsan
#    name: FuntionalStatefulTest-TSAN
#    image: hub.byted.org/bytehouse/clickhouse-stateful-test:stable
#    depends: [scm_build_TSAN]
#    if: ${{ Jobs.scm_build_TSAN.Conclusion == "success" }}
#    runs-on:
#      spec: m1.8xlarge
#      env: online
#    envs:
#      TSAN_OPTIONS: "halt_on_error=false,log_path=/var/log/clickhouse-server/tsan.log"
#    steps:
#      - *action_checkout
#      - *download_scm_binary_tsan
#      - name: Run FuntionalStatefulTest
#        commands:
#          - export sanitizer_type=tsan #Used to control ASAN/TSAN logs
#          - export CLICKHOUSE_WATCHDOG_ENABLE=0
#          - cd /
#          - cp /home/code/docker/test/stateful/run.sh run.sh
#          - cp /home/code/docker/test/stateless/process_functional_tests_result.py process_functional_tests_result.py
#          - /bin/bash run.sh
#      - *after_test
#      - *upload_artifact
#      - *upload_sanitizer_log
#      - *analyse_result
