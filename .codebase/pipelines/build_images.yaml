name: BUILD_IMAGE
trigger:
  change:
    types: ["create", "push"]
    paths:
      - "docker/test/base/*"
      - "docker/test/stateless/*"
      - "docker/test/stateful/*"
      - "docker/test/stress/*"
      - "docker/test/certificate/*"

jobs:
  build_test_base_image:
    name: Build Docker Image For bytehouse/clickhouse-test-base
    image: hub.byted.org/data-ci-debian:latest
    steps:
      - uses: actions/checkout
        inputs:
          depth: 1
      - id: clickhouse-test-base
        uses: actions/buildkit@v1
        inputs:
          context: docker/test/base
          dockerfile: Dockerfile
          output: registry
          image-ref: hub.byted.org/bytehouse/clickhouse-test-base:stable
      - id: clickhouse-stateless-test
        uses: actions/buildkit@v1
        inputs:
          context: docker/test/stateless
          dockerfile: Dockerfile
          output: registry
          image-ref: hub.byted.org/bytehouse/clickhouse-stateless-test:stable
          build-args:
            - TAG=stable
      - id: clickhouse-stateful-test
        uses: actions/buildkit@v1
        inputs:
          context: docker/test/stateful
          dockerfile: Dockerfile
          output: registry
          image-ref: hub.byted.org/bytehouse/clickhouse-stateful-test:stable
          build-args:
            - TAG=stable
      - id: clickhouse-certificate-stateful-test
        uses: actions/buildkit@v1
        inputs:
          context: docker/test/certificate
          dockerfile: Dockerfile
          output: registry
          image-ref: hub.byted.org/bytehouse/clickhouse-stateful-test:certificate
          build-args:
            - TAG=stable
      - id: clickhouse-stress-test
        uses: actions/buildkit@v1
        inputs:
          context: docker/test/stress
          dockerfile: Dockerfile
          output: registry
          image-ref: hub.byted.org/bytehouse/clickhouse-stress-test:stable
          build-args:
            - TAG=stable
    services:
      - id: buildkit
        image: hub.byted.org/pipeline/buildkit
