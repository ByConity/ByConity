USE test;

DROP TABLE IF EXISTS events_funnel;
CREATE TABLE events_funnel (`app_id` UInt32, `hash_uid` UInt64, `time` UInt64, `event` String, `event_date` Date, `loc` String) ENGINE = CnchMergeTree() PARTITION BY (app_id, event_date) ORDER BY (event, hash_uid, time) SAMPLE BY hash_uid SETTINGS index_granularity = 8192;
insert into events_funnel format JSONEachRow {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660739273000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660739267000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660739262000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660739173000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660739166000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660739166000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660739163000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660739084000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660739081000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660739027000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660738945000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660738940000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660738929000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"predefine_pageview","time":1660738902000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660738885000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660738885000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660738863000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723250000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723239000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723194000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723110000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723068000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723048000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660723013000,"hash_uid":1729388853980068489,"loc":"上海"} {"event_date":"2022-08-17","app_id":10000005,"event":"app_launch","time":1660722932000,"hash_uid":1729388853980068489,"loc":"上海"};

-- non group funnel interval
select hash_uid, finderFunnel(8640000, 1660147200, 604800, 1, 0, 0, 'Asia/Shanghai', 1)(toUInt64(time / 1000), case when time <= 2000000000  then time * 100 when time > 2000000000 then toUInt64(time / 10) else time end, unifyNull(((event = 'app_launch')) and ((((loc in ('上海')))))), unifyNull(((event = 'predefine_pageview')))) as funnel_tmp_res from events_funnel et where app_id = 10000005   and ((event = 'app_launch') or (event = 'predefine_pageview'))   and event_date >= '2022-08-11'   and event_date <= '2022-08-18'   and hash_uid = 1729388853980068489 group by hash_uid;
-- group funnel interval
select arrayJoin(assumeNotNull(finderGroupFunnel(8640000, 1660147200, 604800, 1, 1, 0, 0, 'Asia/Shanghai', 1)(toUInt64(time / 1000), case  when time <= 2000000000 then time * 100       when time > 2000000000  then toUInt64(time / 10)       else time end, if(event = 'app_launch', loc, 'NULL'),    unifyNull(((event = 'app_launch'))),        unifyNull(((event = 'predefine_pageview')))))) AS            funnel_res from events_funnel et where app_id = 10000005   and ((event = 'app_launch') or (event = 'predefine_pageview'))   and event_date >= '2022-08-11'   and event_date <= '2022-08-18'   and hash_uid = 1729388853980068489;

DROP TABLE events_funnel;
