SET enable_optimizer = 1;

DROP PREPARED STATEMENT IF EXISTS prep1;
DROP PREPARED STATEMENT IF EXISTS prep2;
DROP PREPARED STATEMENT IF EXISTS prep3;

CREATE PREPARED STATEMENT IF NOT EXISTS prep1 AS
SELECT count()
FROM (SELECT number FROM system.numbers LIMIT 10)
WHERE number < [x: UInt32];

SHOW PREPARED STATEMENTS;

EXPLAIN PREPARED STATEMENT prep1;

SHOW CREATE PREPARED STATEMENT prep1;

CREATE PREPARED STATEMENT OR REPLACE prep1 AS
SELECT count()
FROM (SELECT number FROM system.numbers LIMIT 10)
WHERE number < [i: UInt32];

EXECUTE PREPARED STATEMENT prep1 USING i = 1;
EXECUTE PREPARED STATEMENT prep1 USING i = 5;
EXECUTE PREPARED STATEMENT prep1 USING foo = 'bar'; -- { serverError 4080 }

DROP PREPARED STATEMENT IF EXISTS prep1;

-- test settings effect
SET iterative_optimizer_timeout=111111;

CREATE PREPARED STATEMENT prep2 AS
SELECT value FROM system.settings WHERE name = 'iterative_optimizer_timeout';

CREATE PREPARED STATEMENT prep3 AS
SELECT value FROM system.settings WHERE name = 'iterative_optimizer_timeout'
SETTINGS iterative_optimizer_timeout=333333;

SET iterative_optimizer_timeout=222222;

EXECUTE PREPARED STATEMENT prep2;
EXECUTE PREPARED STATEMENT prep3;
EXECUTE PREPARED STATEMENT prep3 SETTINGS iterative_optimizer_timeout=444444;

SHOW PREPARED STATEMENTS;

DROP PREPARED STATEMENT IF EXISTS prep1;
DROP PREPARED STATEMENT IF EXISTS prep2;
DROP PREPARED STATEMENT IF EXISTS prep3;

set tenant_id='12345';

CREATE PREPARED STATEMENT IF NOT EXISTS prep1 AS
SELECT count()
FROM (SELECT number FROM system.numbers LIMIT 8)
WHERE number < [x: UInt32];

SHOW PREPARED STATEMENTS;
EXPLAIN PREPARED STATEMENT prep1;

set tenant_id='';

CREATE PREPARED STATEMENT IF NOT EXISTS prep1 AS
SELECT count()
FROM (SELECT number FROM system.numbers LIMIT 9)
WHERE number < [x: UInt32];

SHOW PREPARED STATEMENTS;

SHOW CREATE PREPARED STATEMENT `12345.prep1`;
SHOW CREATE PREPARED STATEMENT `prep1`;

EXPLAIN PREPARED STATEMENT `12345.prep1`;
EXPLAIN PREPARED STATEMENT prep1;

set tenant_id='12345';
SHOW PREPARED STATEMENTS;
DROP PREPARED STATEMENT IF EXISTS prep1;

set tenant_id='';
DROP PREPARED STATEMENT IF EXISTS prep1;

DROP PREPARED STATEMENT IF EXISTS prep2;
DROP PREPARED STATEMENT IF EXISTS prep3;

DROP PREPARED STATEMENT IF EXISTS prep4;
CREATE PREPARED STATEMENT IF NOT EXISTS prep4 AS
SELECT count()
FROM (SELECT number FROM system.numbers LIMIT 10)
WHERE number < [x: UInt32];
SHOW PREPARED STATEMENTS;
DROP PREPARED STATEMENT IF EXISTS prep4;
SHOW PREPARED STATEMENTS;

CREATE PREPARED STATEMENT OR REPLACE prep1 AS
SELECT number
FROM
(
    SELECT number
    FROM system.numbers
    LIMIT 10
)
WHERE (number > [i:UInt64]) AND (number IN ([x:Tuple(UInt64)]));

execute PREPARED STATEMENT prep1 using x=(2,4,6), i=6;

CREATE PREPARED STATEMENT OR REPLACE prep1 AS
SELECT number
FROM
(
    SELECT number
    FROM system.numbers
    LIMIT 10
)
WHERE has([x:Array(Nullable(String))], NULL);

execute PREPARED STATEMENT prep1 using x=['1','2',null];

DROP PREPARED STATEMENT IF EXISTS prep1;
