drop database if exists 10724_test;
create database if not exists 10724_test;
drop table if exists 10724_test.10724_t1;
drop table if exists 10724_test.10724_t2;
create table 10724_test.10724_t1 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
create table 10724_test.10724_t2 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
select 'bucket table by EXPRESSION';
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;
create stats 10724_test.10724_t1 FORMAT Null;
create stats 10724_test.10724_t2 FORMAT Null;
select 'bucket table by EXPRESSION after create stats';
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;
select 'bucket table by EXPRESSION after alter table';
alter table 10724_test.10724_t2 modify cluster by EXPRESSION toUInt64(a % 4) INTO 4 BUCKETS;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;

select 'bucket table by EXPRESSION with different buckets by same multiplier';
drop table if exists 10724_test.10724_t1;
drop table if exists 10724_test.10724_t2;
create table 10724_test.10724_t1 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
create table 10724_test.10724_t2 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 4 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
create stats 10724_test.10724_t1 FORMAT Null;
create stats 10724_test.10724_t2 FORMAT Null;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings distributed_max_parallel_size=4;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t2,10724_test.10724_t1 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings distributed_max_parallel_size=4;

select 'bucket table by EXPRESSION with different buckets by different multiplier';
drop table if exists 10724_test.10724_t1;
drop table if exists 10724_test.10724_t2;
create table 10724_test.10724_t1 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
create table 10724_test.10724_t2 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 3 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
create stats 10724_test.10724_t1 FORMAT Null;
create stats 10724_test.10724_t2 FORMAT Null;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings distributed_max_parallel_size=4;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t2,10724_test.10724_t1 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings distributed_max_parallel_size=4;

drop table if exists 10724_test.10724_t1;
drop table if exists 10724_test.10724_t2;
create table 10724_test.10724_t1 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY toUInt64(a) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t1 (a,b) VALUES (1,1);
create table 10724_test.10724_t2 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY toUInt64(a) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (0,1);
INSERT INTO 10724_test.10724_t2 (a,b) VALUES (1,1);
select 'bucket table';
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;
create stats 10724_test.10724_t1 FORMAT Null;
create stats 10724_test.10724_t2 FORMAT Null;
select 'bucket table after create stats';
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;
select 'bucket table by EXPRESSION after alter table';
alter table 10724_test.10724_t2 modify cluster by EXPRESSION toUInt64(a % 4) INTO 4 BUCKETS;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;

drop table if exists 10724_test.10724_t1;
drop table if exists 10724_test.10724_t2;
create table 10724_test.10724_t1 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
create table 10724_test.10724_t2 (a Int32, b Int32) ENGINE=CnchMergeTree() ORDER BY a CLUSTER BY EXPRESSION toUInt64(a % 2) INTO 2 BUCKETS settings cnch_merge_max_total_rows_to_merge=1;
select 'empty table';
create stats 10724_test.10724_t1 FORMAT Null;
create stats 10724_test.10724_t2 FORMAT Null;
select 10724_test.10724_t1.a,10724_test.10724_t2.b from 10724_test.10724_t1,10724_test.10724_t2 where 10724_test.10724_t1.a=10724_test.10724_t2.a order by 10724_test.10724_t1.a settings bsp_mode=1,distributed_max_parallel_size=4;
drop table if exists 10724_test.10724_t1;
drop table if exists 10724_test.10724_t2;
drop database if exists 10724_test;