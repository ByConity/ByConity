SELECT 'Still alive';

-- Test for tsan: Ensure cache used from one thread
SET max_threads = 32;

DROP TABLE IF EXISTS sample;

CREATE TABLE sample (d Date DEFAULT '2000-01-01', x UInt16) ENGINE = CnchMergeTree() PARTITION BY toYYYYMM(d) SAMPLE BY x ORDER BY x SETTINGS index_granularity = 10;
INSERT INTO sample (x) SELECT toUInt16(number) AS x FROM system.numbers LIMIT 65536;

SELECT count()
FROM
(
    SELECT
        x,
        count() AS c
    FROM
    (
                  SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
        UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    UNION ALL SELECT * FROM ( SELECT * FROM sample WHERE x > 0 )
    )
    GROUP BY x
    --HAVING c = 1
    ORDER BY x ASC
);
DROP TABLE sample;
